{% extends "base.html" %}

{% block title %}UBTool - Ubuntu Touch Connection Tool{% endblock %}

{% block extra_css %}
<style>
    .status-connected {
        background: #4CAF50 !important;
        box-shadow: 0 0 8px rgba(76, 175, 80, 0.4);
        animation: pulse-green 2s infinite;
    }
    
    .status-disconnected {
        background: #f44336 !important;
        box-shadow: 0 0 8px rgba(244, 67, 54, 0.4);
        animation: pulse-red 2s infinite;
    }
    
    @keyframes pulse-green {
        0% { opacity: 1; }
        50% { opacity: 0.7; }
        100% { opacity: 1; }
    }
    
    @keyframes pulse-red {
        0% { opacity: 1; }
        50% { opacity: 0.7; }
        100% { opacity: 1; }
    }
    
    .device-card {
        transition: all 0.3s ease;
    }
    
    .device-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(0,0,0,0.15);
    }
</style>
{% endblock %}

{% block content %}
<!-- Hero Section -->
<section class="hero-section" style="background: linear-gradient(135deg, var(--ub-dark) 0%, #2c2c2c 100%); padding: 4rem 0; text-align: center;">
    <div class="w3-content" style="max-width: 1200px; margin: 0 auto; padding: 0 2rem;">
        <h1 class="hero-title" style="color: var(--ub-orange); margin-bottom: 1rem;">
            üöÄ UBTool
        </h1>
        <p class="hero-subtitle" style="color: var(--ub-light); opacity: 0.9;">
            <span data-i18n="hero.subtitle">Conecta y gestiona dispositivos Ubuntu Touch v√≠a ADB</span>
        </p>
        
        <!-- Device Status Card -->
        <div style="display: flex; justify-content: center; margin-top: 3rem;">
            <div class="device-card" style="text-align: center; max-width: 600px; width: 100%;">
                <div style="display: flex; justify-content: center; align-items: center; gap: 0.5rem; margin-bottom: 1rem;">
                    <h3 class="w3-text-orange" data-i18n="device.title">Estado del Dispositivo</h3>
                    <div id="status-indicator" style="width: 12px; height: 12px; border-radius: 50%; background: #666; transition: all 0.3s ease;"></div>
                </div>
                <div id="device-info" style="text-align: left;">
                    <p style="color: #666;" data-i18n="device.loading">Cargando informaci√≥n del dispositivo...</p>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- Features Section -->
<section class="features-section" style="padding: 4rem 0; background: rgba(0,0,0,0.2);">
    <div class="w3-content" style="max-width: 1200px; margin: 0 auto; padding: 0 2rem;">
        <div style="text-align: center; margin-bottom: 3rem;">
            <h2 class="hero-title w3-text-orange" style="margin-bottom: 1rem;" data-i18n="features.title">Caracter√≠sticas</h2>
            <p style="opacity: 0.8; font-size: 1.1rem;" data-i18n="features.subtitle">Descubre las potentes funcionalidades de UBTool</p>
        </div>
        
        <div style="display: flex; justify-content: center; align-items: stretch; gap: 3rem; margin-bottom: 3rem; flex-wrap: wrap;">
            <div style="flex: 1; min-width: 300px; max-width: 350px;">
                <div class="device-card" style="text-align: center; height: 100%; padding: 2rem;">
                    <div style="font-size: 3rem; margin-bottom: 1.5rem;">üîó</div>
                    <h3 style="color: var(--ub-orange); margin-bottom: 1.5rem;" data-i18n="features.adb.title">Conexi√≥n ADB</h3>
                    <p style="line-height: 1.6; opacity: 0.9; font-size: 1rem;" data-i18n="features.adb.desc">Conecta y gestiona dispositivos Ubuntu Touch v√≠a ADB con interfaz web moderna</p>
                </div>
            </div>
            
            <div style="flex: 1; min-width: 300px; max-width: 350px;">
                <div class="device-card" style="text-align: center; height: 100%; padding: 2rem;">
                    <div style="font-size: 3rem; margin-bottom: 1.5rem;">üì±</div>
                    <h3 style="color: var(--ub-orange); margin-bottom: 1.5rem;" data-i18n="features.devices.title">Gesti√≥n de Dispositivos</h3>
                    <p style="line-height: 1.6; opacity: 0.9; font-size: 1rem;" data-i18n="features.devices.desc">Visualiza y controla m√∫ltiples dispositivos conectados simult√°neamente</p>
                </div>
            </div>
            
            <div style="flex: 1; min-width: 300px; max-width: 350px;">
                <div class="device-card" style="text-align: center; height: 100%; padding: 2rem;">
                    <div style="font-size: 3rem; margin-bottom: 1.5rem;">üåê</div>
                    <h3 style="color: var(--ub-orange); margin-bottom: 1.5rem;" data-i18n="features.web.title">Interfaz Web</h3>
                    <p style="line-height: 1.6; opacity: 0.9; font-size: 1rem;" data-i18n="features.web.desc">Accede desde cualquier navegador moderno con dise√±o responsive y temas Ubuntu Touch</p>
                </div>
            </div>
        </div>
        
        <!-- Second Row of Features -->
        <div style="display: flex; justify-content: center; align-items: stretch; gap: 3rem; flex-wrap: wrap;">
            <div style="flex: 1; min-width: 300px; max-width: 350px;">
                <div class="device-card" style="text-align: center; height: 100%; padding: 2rem;">
                    <div style="font-size: 3rem; margin-bottom: 1.5rem;">üñ•Ô∏è</div>
                    <h3 style="color: var(--ub-orange); margin-bottom: 1.5rem;" data-i18n="features.terminal.title">Terminal Integrada</h3>
                    <p style="line-height: 1.6; opacity: 0.9; font-size: 1rem;" data-i18n="features.terminal.desc">Ejecuta comandos ADB directamente desde la interfaz web</p>
                </div>
            </div>
            
            <div style="flex: 1; min-width: 300px; max-width: 350px;">
                <div class="device-card" style="text-align: center; height: 100%; padding: 2rem;">
                    <div style="font-size: 3rem; margin-bottom: 1.5rem;">üìÅ</div>
                    <h3 style="color: var(--ub-orange); margin-bottom: 1.5rem;" data-i18n="features.files.title">File Manager</h3>
                    <p style="line-height: 1.6; opacity: 0.9; font-size: 1rem;" data-i18n="features.files.desc">Explora y gestiona archivos del dispositivo con interfaz intuitiva</p>
                </div>
            </div>
            
            <div style="flex: 1; min-width: 300px; max-width: 350px;">
                <div class="device-card" style="text-align: center; height: 100%; padding: 2rem;">
                    <div style="font-size: 3rem; margin-bottom: 1.5rem;">üöÄ</div>
                    <h3 style="color: var(--ub-orange); margin-bottom: 1.5rem;" data-i18n="features.webapps.title">Web Apps</h3>
                    <p style="line-height: 1.6; opacity: 0.9; font-size: 1rem;" data-i18n="features.webapps.desc">Crea y gestiona aplicaciones web con Click y prepara para deployment</p>
                </div>
            </div>
        </div>
    </div>
</section>
{% endblock %}

{% block scripts %}
<script>
    // Helper function to safely parse JSON responses
    async function parseJSONResponse(response) {
        if (!response.ok) {
            if (response.status === 413) {
                throw new Error('El archivo es demasiado grande. El tama√±o m√°ximo permitido es 100MB.');
            }
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const text = await response.text();
        if (!text) {
            throw new Error('Empty response from server');
        }
        
        try {
            return JSON.parse(text);
        } catch (jsonError) {
            console.error('JSON parse error:', jsonError, 'Response text:', text);
            throw new Error(`Invalid JSON response: ${jsonError.message}`);
        }
    }

    // Internationalization
    const UBTOOL_I18N = {
        'es': {
            'status.checking': 'Verificando...',
            'status.connected': 'Conectado',
            'status.disconnected': 'Desconectado',
            'device.title': 'Estado del Dispositivo',
            'device.loading': 'Cargando informaci√≥n del dispositivo...',
            'device.tutorial.title': 'üîß Tutorial: Habilitar ADB en Ubuntu Touch',
            'device.tutorial.step1': '1. Abre: Configuraci√≥n del sistema',
            'device.tutorial.step2': '2. Ve a: Informaci√≥n del sistema',
            'device.tutorial.step3': '3. Busca: "Modo desarrollador"',
            'device.tutorial.step4': '4. Activa: "Modo desarrollador"',
            'device.tutorial.step5': '5. Busca: "Depuraci√≥n de Android (ADB)"',
            'device.tutorial.step6': '6. Activa: "Depuraci√≥n de Android (ADB)"',
            'device.tutorial.step7': '7. Conecta: USB y selecciona "Transferir archivos"',
            'device.tutorial.note': 'üîë Si te pide clave, ingr√©sala para habilitar el modo',
            'hero.subtitle': 'Conecta y gestiona dispositivos Ubuntu Touch v√≠a ADB',
            'tools.title': 'Herramientas R√°pidas',
            'tools.subtitle': 'Acceso r√°pido a funciones ADB',
            'tools.shell': 'üñ•Ô∏è Shell',
            'tools.reboot': 'üîÑ Reiniciar',
            'webapps.title': 'Apps Web',
            'webapps.prepare': 'Preparar entorno global (pip/virtualenv)',
            'webapps.name': 'Nombre:',
            'webapps.name_ph': 'mi_app',
            'webapps.framework': 'Framework:',
            'webapps.create': 'Crear WebApp',
            'webapps.installed.title': 'Apps Instaladas',
            'webapps.installed.refresh': 'üîÑ Actualizar Lista',
            'webapps.installed.loading': 'Cargando...',
            'webapps.installed.start': '‚ñ∂Ô∏è Iniciar',
            'webapps.installed.stop': '‚èπÔ∏è Detener',
            'webapps.installed.delete': 'üóëÔ∏è Eliminar',
            'webapps.installed.prepare': 'üöÄ Preparar',
            'webapps.installed.no_apps': 'No hay apps instaladas',
            'webapps.create.title': 'Crear Nueva WebApp',
            'webapps.create.name': 'Nombre de la App:',
            'webapps.create.name_ph': 'mi_app',
            'webapps.create.name_hint': 'Ej: mi_app, blog-todo, api_rest',
            'webapps.create.framework': 'Framework/Servidor:',
            'webapps.create.framework_ph': 'Selecciona un framework...',
            'webapps.create.framework_hint': 'Microdot es optimizado para Ubuntu Touch',
            'webapps.create.port': 'Puerto (opcional):',
            'webapps.create.port_ph': '8081',
            'webapps.create.port_hint': 'Si no especificas, se usar√° un puerto disponible autom√°ticamente',
            'webapps.create.venv': 'Usar entorno virtual global (recomendado)',
            'webapps.create.venv_hint': 'Usa el entorno global compartido configurado en UBTool',
            'webapps.create.submit': 'üöÄ Crear WebApp',
            'webapps.create.creating': '‚è≥ Creando...',
            'webapps.create.success': '‚úÖ Creado Exitosamente',
            'webapps.create.cancel': 'Cancelar',
            'webapps.create.status_creating': 'üîÑ Creando aplicaci√≥n web...',
            'webapps.create.error_required': '‚ùå Por favor completa todos los campos requeridos',
            'files.title': 'üìÅ File Manager',
            'files.subtitle': 'Explora archivos del dispositivo',
            'files.open': 'Abrir',
            'features.title': 'Caracter√≠sticas',
            'features.adb.title': 'Conexi√≥n ADB',
            'features.adb.desc': 'Conecta y gestiona dispositivos Ubuntu Touch v√≠a ADB con interfaz web moderna',
            'features.devices.title': 'Gesti√≥n de Dispositivos',
            'features.devices.desc': 'Visualiza y controla m√∫ltiples dispositivos conectados simult√°neamente',
            'features.web.title': 'Interfaz Web',
            'features.web.desc': 'Accede desde cualquier navegador moderno con dise√±o responsive y temas Ubuntu Touch',
            'features.terminal.title': 'Terminal Integrada',
            'features.terminal.desc': 'Ejecuta comandos ADB directamente desde la interfaz web',
            'features.files.title': 'Gestor de Archivos',
            'features.files.desc': 'Explora y gestiona archivos del dispositivo con interfaz intuitiva',
            'features.webapps.title': 'Aplicaciones Web',
            'features.webapps.desc': 'Crea y gestiona aplicaciones web con Click y prepara para deployment',
            'webapps.create.icon.title': 'üé® Icono de la App (opcional)',
            'webapps.create.icon.hint': 'Formatos: PNG, JPG, SVG. Se redimensionar√° autom√°ticamente a 64x64px',
            'webapps.create.icon.no_selection': 'No hay icono seleccionado',
            'footer.about': 'Acerca de UBTool',
            'footer.description': 'Herramienta moderna para gestionar dispositivos Ubuntu Touch v√≠a ADB con interfaz web intuitiva.',
            'footer.support': 'Apoya el proyecto',
            'footer.buy_coffee': 'Buy Me a Coffee',
            'footer.rights': 'Todos los derechos reservados.'
        },
        'en': {
            'status.checking': 'Checking...',
            'status.connected': 'Connected',
            'status.disconnected': 'Disconnected',
            'device.title': 'Device Status',
            'device.loading': 'Loading device information...',
            'device.tutorial.title': 'üîß Tutorial: Enable ADB on Ubuntu Touch',
            'device.tutorial.step1': '1. Open: System Settings',
            'device.tutorial.step2': '2. Go to: System Information',
            'device.tutorial.step3': '3. Search: "Developer mode"',
            'device.tutorial.step4': '4. Enable: "Developer mode"',
            'device.tutorial.step5': '5. Search: "Android debugging (ADB)"',
            'device.tutorial.step6': '6. Enable: "Android debugging (ADB)"',
            'device.tutorial.step7': '7. Connect: USB and select "Transfer files"',
            'device.tutorial.note': 'üîë If asked for password, enter it to enable the mode',
            'hero.subtitle': 'Connect and manage Ubuntu Touch devices via ADB',
            'tools.title': 'Quick Tools',
            'tools.subtitle': 'Quick access to ADB features',
            'tools.shell': 'üñ•Ô∏è Shell',
            'tools.reboot': 'üîÑ Reboot',
            'webapps.title': 'Web Apps',
            'webapps.prepare': 'Prepare global environment (pip/virtualenv)',
            'webapps.name': 'Name:',
            'webapps.name_ph': 'my_app',
            'webapps.framework': 'Framework:',
            'webapps.create': 'Create WebApp',
            'webapps.installed.title': 'Installed Apps',
            'webapps.installed.refresh': 'üîÑ Refresh List',
            'webapps.installed.loading': 'Loading...',
            'webapps.installed.start': '‚ñ∂Ô∏è Start',
            'webapps.installed.stop': '‚èπÔ∏è Stop',
            'webapps.installed.delete': 'üóëÔ∏è Delete',
            'webapps.installed.prepare': 'üöÄ Prepare',
            'webapps.installed.no_apps': 'No installed apps',
            'webapps.create.title': 'Create New WebApp',
            'webapps.create.name': 'App Name:',
            'webapps.create.name_ph': 'my_app',
            'webapps.create.name_hint': 'e.g.: my_app, blog-todo, api_rest',
            'webapps.create.framework': 'Framework/Server:',
            'webapps.create.framework_ph': 'Select a framework...',
            'webapps.create.framework_hint': 'Microdot is optimized for Ubuntu Touch',
            'webapps.create.port': 'Port (optional):',
            'webapps.create.port_ph': '8081',
            'webapps.create.port_hint': 'If not specified, an available port will be used automatically',
            'webapps.create.venv': 'Use global virtual environment (recommended)',
            'webapps.create.venv_hint': 'Uses the shared global environment configured in UBTool',
            'webapps.create.submit': 'üöÄ Create WebApp',
            'webapps.create.creating': '‚è≥ Creating...',
            'webapps.create.success': '‚úÖ Successfully Created',
            'webapps.create.cancel': 'Cancel',
            'webapps.create.status_creating': 'üîÑ Creating web application...',
            'webapps.create.error_required': '‚ùå Please complete all required fields',
            'files.title': 'üìÅ File Manager',
            'files.subtitle': 'Browse device files',
            'files.open': 'Open',
            'features.title': 'Features',
            'features.adb.title': 'ADB Connection',
            'features.adb.desc': 'Connect and manage Ubuntu Touch devices via ADB with a modern web UI',
            'features.devices.title': 'Device Management',
            'features.devices.desc': 'View and control multiple connected devices simultaneously',
            'features.web.title': 'Web Interface',
            'features.web.desc': 'Access from any modern browser with responsive design and Ubuntu Touch styling',
            'features.terminal.title': 'Integrated Terminal',
            'features.terminal.desc': 'Execute ADB commands directly from the web interface',
            'features.files.title': 'File Manager',
            'features.files.desc': 'Explore and manage device files with intuitive interface',
            'features.webapps.title': 'Web Apps',
            'features.webapps.desc': 'Create and manage web applications with Click and prepare for deployment',
            'webapps.create.icon.title': 'üé® App Icon (optional)',
            'webapps.create.icon.hint': 'Formats: PNG, JPG, SVG. Will be automatically resized to 64x64px',
            'webapps.create.icon.no_selection': 'No icon selected',
            'footer.description': 'Complete tool for managing Ubuntu Touch devices via ADB',
            'footer.resources.title': 'üìö Resources',
            'footer.resources.github': 'GitHub',
            'footer.resources.issues': 'Issues',
            'footer.support.title': '‚òï Support',
            'footer.support.description': 'If you like this project, consider supporting it:',
            'footer.support.link': 'Buy Me a Coffee',
            'footer.update.available': 'New version available: ',
            'footer.update.current': 'Your version: ',
            'footer.update.button': 'Update Now',
            'footer.copyright': '¬© 2026 UBTool - Developed with ‚ù§Ô∏è for Ubuntu Touch'
        }
    };

    let currentLanguage = localStorage.getItem('ubtool_lang') || 'es';

    function getCurrentLanguage() {
        return currentLanguage;
    }

    function applyTranslations(lang) {
        currentLanguage = lang;
        localStorage.setItem('ubtool_lang', lang);
        
        document.querySelectorAll('[data-i18n]').forEach(element => {
            const key = element.getAttribute('data-i18n');
            if (UBTOOL_I18N[lang] && UBTOOL_I18N[lang][key]) {
                element.textContent = UBTOOL_I18N[lang][key];
            }
        });
        
        document.querySelectorAll('[data-i18n-placeholder]').forEach(element => {
            const key = element.getAttribute('data-i18n-placeholder');
            if (UBTOOL_I18N[lang] && UBTOOL_I18N[lang][key]) {
                element.placeholder = UBTOOL_I18N[lang][key];
            }
        });
        
        // Update language toggle button
        const langToggle = document.getElementById('lang-toggle');
        if (langToggle) {
            langToggle.textContent = lang === 'es' ? 'üåê EN' : 'üåê ES';
        }
    }

    function toggleLanguage() {
        const newLang = currentLanguage === 'es' ? 'en' : 'es';
        applyTranslations(newLang);
    }

    // Device status checking
    async function checkDevice() {
        try {
            const response = await fetch('/api/device/status');
            const data = await parseJSONResponse(response);
            
            const statusIndicator = document.getElementById('status-indicator');
            const statusText = document.getElementById('status-text');
            const deviceInfo = document.getElementById('device-info');
            
            if (data.connected) {
                statusIndicator.className = 'status-connected';
                statusText.textContent = UBTOOL_I18N[currentLanguage]['status.connected'];
                
                // Load device info
                const infoResponse = await fetch('/api/device/info');
                const infoData = await infoResponse.json();
                
                if (infoData.success) {
                    const info = infoData.info;
                    const memory = info.memory || {};
                    const storage = info.storage || {};
                    const primaryStorage = storage.primary || {};
                    
                    deviceInfo.innerHTML = `
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
                            <div><strong>Modelo:</strong> ${info.model || 'N/A'}</div>
                            <div><strong>Versi√≥n:</strong> ${info.version || 'N/A'}</div>
                            <div><strong>SO:</strong> ${info.os_name || 'N/A'} ${info.os_version || ''}</div>
                            <div><strong>IP:</strong> ${info.ip_address || 'N/A'}</div>
                            <div><strong>Bater√≠a:</strong> ${info.battery || 'N/A'}</div>
                            <div><strong>RAM:</strong> ${memory.total || 'N/A'} (${memory.used || 'N/A'} usados)</div>
                            <div><strong>Almacenamiento:</strong> ${primaryStorage.size || 'N/A'} (${primaryStorage.used || 'N/A'} usados)</div>
                            <div><strong>Serial:</strong> ${info.serial || 'N/A'}</div>
                        </div>
                    `;
                }
            } else {
                statusIndicator.className = 'status-disconnected';
                statusText.textContent = UBTOOL_I18N[currentLanguage]['status.disconnected'];
                
                // Show ADB tutorial when disconnected
                deviceInfo.innerHTML = `
                    <div style="margin-bottom: 1.5rem;">
                        <p style="color: #f44336; margin-bottom: 1rem;">${data.error || 'No se puede conectar al dispositivo'}</p>
                    </div>
                    
                    <div style="background: rgba(233,84,32,0.1); border: 1px solid var(--ub-orange); border-radius: 8px; padding: 1.5rem;">
                        <h4 style="color: var(--ub-orange); margin: 0 0 1rem 0; font-size: 1.1rem;" data-i18n="device.tutorial.title">üîß Tutorial: Habilitar ADB en Ubuntu Touch</h4>
                        
                        <div style="background: rgba(255,255,255,0.05); border-radius: 6px; padding: 1rem; margin-bottom: 1rem;">
                            <ol style="margin: 0; padding-left: 1.5rem; color: var(--ub-light); line-height: 1.6;">
                                <li style="margin-bottom: 0.5rem;" data-i18n="device.tutorial.step1">1. Abre: Configuraci√≥n del sistema</li>
                                <li style="margin-bottom: 0.5rem;" data-i18n="device.tutorial.step2">2. Ve a: Informaci√≥n del sistema</li>
                                <li style="margin-bottom: 0.5rem;" data-i18n="device.tutorial.step3">3. Busca: "Modo desarrollador"</li>
                                <li style="margin-bottom: 0.5rem;" data-i18n="device.tutorial.step4">4. Activa: "Modo desarrollador"</li>
                                <li style="margin-bottom: 0.5rem;" data-i18n="device.tutorial.step5">5. Busca: "Depuraci√≥n de Android (ADB)"</li>
                                <li style="margin-bottom: 0.5rem;" data-i18n="device.tutorial.step6">6. Activa: "Depuraci√≥n de Android (ADB)"</li>
                                <li style="margin-bottom: 0.5rem;" data-i18n="device.tutorial.step7">7. Conecta: USB y selecciona "Transferir archivos"</li>
                            </ol>
                        </div>
                        
                        <div style="background: rgba(255,193,7,0.1); border-left: 4px solid #ffc107; padding: 0.75rem; margin-top: 1rem;">
                            <p style="margin: 0; color: var(--ub-light); font-size: 0.9rem;" data-i18n="device.tutorial.note">
                                üí° Si te pide clave, ingr√©sala para habilitar el modo
                            </p>
                        </div>
                        
                        <div style="text-align: center; margin-top: 1.5rem;">
                            <button onclick="checkDevice()" class="btn-ub" style="background: var(--ub-orange); color: white; padding: 0.75rem 1.5rem; border-radius: 6px;">
                                üîÑ Reintentar Conexi√≥n
                            </button>
                        </div>
                    </div>
                `;
                
                // Apply translations to tutorial content
                setTimeout(() => {
                    applyTranslations(currentLanguage);
                }, 100);
            }
        } catch (error) {
            console.error('Error checking device:', error);
            document.getElementById('status-text').textContent = 'Error';
        }
    }

    // Global functions for modals and tools
    function openTerminal() {
        createRealTerminalModal();
    }

    function openFileManager() {
        const modal = document.createElement('div');
        modal.id = 'file-manager-modal';
        modal.style.cssText = `
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        `;

        modal.innerHTML = `
            <div style="background: var(--ub-dark); border: 2px solid var(--ub-orange); border-radius: 12px; padding: 1rem; max-width: 900px; width: 95%; max-height: 90vh; overflow: hidden;">
                <div style="display:flex; justify-content: space-between; align-items:center; gap: 0.5rem; margin-bottom: 0.75rem;">
                    <h3 style="color: var(--ub-orange); margin: 0;">üìÅ File Manager</h3>
                    <button onclick="closeFileManager()" style="background: none; border: none; color: var(--ub-light); font-size: 1.5rem; cursor: pointer;">&times;</button>
                </div>
                <div style="display:flex; gap: 0.5rem; align-items:center; margin-bottom: 0.75rem;">
                    <button class="btn-ub" style="padding: 0.5rem 0.75rem;" onclick="fmGoUp()">‚¨ÜÔ∏è</button>
                    <input id="fm-path" type="text" style="flex:1; background: rgba(255,255,255,0.1); border: 1px solid var(--ub-gray); color: var(--ub-light); padding: 0.6rem; border-radius: 6px;" />
                    <button class="btn-ub" style="padding: 0.5rem 0.75rem;" onclick="fmGoToPath()">Ir</button>
                </div>
                <div id="fm-status" style="margin-bottom: 0.5rem; opacity: 0.9;"></div>
                <div id="fm-list" style="background: rgba(0,0,0,0.35); border: 1px solid var(--ub-gray); border-radius: 8px; padding: 0.5rem; height: 60vh; overflow-y: auto; font-family: 'Ubuntu', 'Arial', sans-serif;"></div>
            </div>
        `;

        document.body.appendChild(modal);
        document.getElementById('fm-path').value = fmCurrentPath;
        loadFileManagerPath(fmCurrentPath);
    }

    // File Manager Functions

    function closeFileManager() {
        const modal = document.getElementById('file-manager-modal');
        if (modal) modal.remove();
    }

    function fmGoUp() {
        if (!fmCurrentPath || fmCurrentPath === '/') {
            loadFileManagerPath('/');
            return;
        }
        const parent = fmCurrentPath.replace(/\/+$/, '').split('/').slice(0, -1).join('/') || '/';
        loadFileManagerPath(parent);
    }

    function fmGoToPath() {
        const p = (document.getElementById('fm-path').value || '').trim();
        if (!p) return;
        loadFileManagerPath(p);
    }

    async function loadFileManagerPath(path) {
        const status = document.getElementById('fm-status');
        const list = document.getElementById('fm-list');
        const pathInput = document.getElementById('fm-path');
        if (!status || !list || !pathInput) return;

        status.innerHTML = '<span class="loading-spinner"></span> Cargando...';
        list.innerHTML = '';

        try {
            const url = `/api/files/list?path=${encodeURIComponent(path)}`;
            const response = await fetch(url);
            const data = await parseJSONResponse(response);

            if (!data.success) {
                status.innerHTML = `‚ùå ${data.error || 'Error al listar'}`;
                return;
            }

            const payload = data.data;
            fmCurrentPath = payload.path || path;
            pathInput.value = fmCurrentPath;
            status.textContent = fmCurrentPath;

            const entries = payload.entries || [];
            if (!entries.length) {
                list.innerHTML = '<div style="opacity:0.8; padding: 0.5rem;">(vac√≠o)</div>';
                return;
            }

            let html = '';
            for (const e of entries) {
                const name = e.name || '';
                const isDir = !!e.is_dir;
                const size = e.size_human || '';
                const rowStyle = 'display:flex; justify-content: space-between; gap: 0.75rem; padding: 0.5rem; border-radius: 6px; cursor: pointer;';
                
                let left;
                if (isDir) {
                    left = `üìÅ ${name}`;
                } else {
                    const ext = (name.split('.').pop() || '').toLowerCase();
                    const videoFormats = ['mp4', 'webm', 'ogg', 'mov', 'mkv', 'avi', '3gp', 'flv', 'wmv', 'm4v', 'wav', 'weba', 'mpg', 'mpeg', 'm4a'];
                    const imageFormats = ['png', 'jpg', 'jpeg', 'gif', 'bmp', 'webp', 'svg', 'ico'];
                    
                    if (videoFormats.includes(ext)) {
                        left = `üìπ ${name}`;
                    } else if (imageFormats.includes(ext)) {
                        left = `üñºÔ∏è ${name}`;
                    } else {
                        left = `üìÑ ${name}`;
                    }
                }
                
                html += `
                    <div style="${rowStyle}" onmouseover="this.style.background='rgba(233,84,32,0.10)'" onmouseout="this.style.background='transparent'" onclick="fmEntryClick(${isDir ? 'true' : 'false'}, '${encodeURIComponent(name)}')">
                        <div style="overflow:hidden; text-overflow: ellipsis; white-space: nowrap;">${left}</div>
                        <div style="opacity:0.8; white-space: nowrap;">${isDir ? '' : size}</div>
                    </div>
                `;
            }
            list.innerHTML = html;
        } catch (e) {
            status.innerHTML = `‚ùå Error: ${e.message}`;
        }
    }

    function fmEntryClick(isDir, encodedName) {
        const name = decodeURIComponent(encodedName || '');
        if (!name) return;
        if (isDir) {
            const base = (fmCurrentPath || '/').replace(/\/+$/, '');
            const next = (base === '' || base === '/') ? `/${name}` : `${base}/${name}`;
            loadFileManagerPath(next);
        } else {
            const base = (fmCurrentPath || '/').replace(/\/+$/, '');
            const fullPath = (base === '' || base === '/') ? `/${name}` : `${base}/${name}`;
            openFile(fullPath);
        }
    }

    function closeFileViewer() {
        const modal = document.getElementById('file-viewer-modal');
        if (modal) modal.remove();
    }

    async function openFile(path) {
        // Check if it's a video file first
        const ext = (path.split('.').pop() || '').toLowerCase();
        const videoFormats = ['mp4', 'webm', 'ogg', 'mov', 'mkv', 'avi', '3gp', 'flv', 'wmv', 'm4v', 'wav', 'weba'];
        
        if (videoFormats.includes(ext)) {
            // Open video directly in player
            openBinaryViewer(path);
            return;
        }
        
        // Check if it's an image file
        const imageFormats = ['png', 'jpg', 'jpeg', 'gif', 'bmp', 'webp', 'svg', 'ico'];
        if (imageFormats.includes(ext)) {
            // Open image directly in viewer
            openBinaryViewer(path);
            return;
        }
        
        // For other files, try to open as text first
        try {
            const res = await fetch(`/api/files/text?path=${encodeURIComponent(path)}`);
            const data = await res.json();
            if (data.success) {
                openTextEditor(path, data.content || '', data.mime || 'text/plain');
                return;
            }
        } catch (e) {
            // Fall back to viewer
        }

        openBinaryViewer(path);
    }

    function openBinaryViewer(path) {
        const modal = document.createElement('div');
        modal.id = 'file-viewer-modal';
        modal.style.cssText = `
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1100;
        `;

        const url = `/api/files/raw?path=${encodeURIComponent(path)}`;
        const ext = (path.split('.').pop() || '').toLowerCase();
        const isImage = ['png','jpg','jpeg','gif','bmp','webp','svg','ico'].includes(ext);
        const isVideo = ['mp4','webm','ogg','mov','mkv','avi','3gp','flv','wmv','m4v','wav','weba','mpg','mpeg','m4a'].includes(ext);

        let body = '';
        if (isImage) {
            body = `<img src="${url}" style="max-width: 100%; max-height: 70vh; border-radius: 8px;" />`;
        } else if (isVideo) {
            body = `
                <video src="${url}" controls style="max-width: 100%; max-height: 70vh; border-radius: 8px;" autoplay>
                    Tu navegador no soporta el elemento de video.
                </video>
                <div style="text-align: center; margin-top: 1rem;">
                    <p style="color: var(--ub-gray); font-size: 0.9rem;">
                        üìπ Reproduciendo: <code style="background: rgba(255,255,255,0.1); padding: 2px 6px; border-radius: 4px;">${path}</code>
                    </p>
                </div>
            `;
        } else {
            body = `<div style="opacity:0.9; margin-bottom: 1rem;">Archivo: <code>${path}</code></div>
                    <a class="btn-ub" href="${url}" target="_blank" rel="noopener">Abrir/Descargar</a>`;
        }

        modal.innerHTML = `
            <div style="background: var(--ub-dark); border: 2px solid var(--ub-orange); border-radius: 12px; padding: 1rem; max-width: 1000px; width: 95%; max-height: 90vh; overflow: auto;">
                <div style="display:flex; justify-content: space-between; align-items:center; gap: 0.5rem; margin-bottom: 0.75rem;">
                    <h3 style="color: var(--ub-orange); margin: 0;">
                        ${isImage ? 'üñºÔ∏è Imagen' : isVideo ? 'üìπ Reproductor de Video' : 'üëÅÔ∏è Viewer'}
                    </h3>
                    <button onclick="closeFileViewer()" style="background: none; border: none; color: var(--ub-light); font-size: 1.5rem; cursor: pointer;">&times;</button>
                </div>
                <div style="text-align: center;">
                    ${body}
                </div>
                ${isVideo ? `
                <div style="display: flex; justify-content: center; gap: 1rem; margin-top: 1rem;">
                    <a href="${url}" download="${path.split('/').pop()}" class="btn-ub" style="background: var(--ub-orange); color: white; text-decoration: none; padding: 0.5rem 1rem; border-radius: 6px;">
                        üíæ Descargar Video
                    </a>
                    <button onclick="closeFileViewer()" class="btn-ub" style="background: rgba(255,255,255,0.1); color: var(--ub-light); border: 1px solid var(--ub-orange); padding: 0.5rem 1rem; border-radius: 6px;">
                        Cerrar
                    </button>
                </div>
                ` : ''}
            </div>
        `;

        document.body.appendChild(modal);
        
        // Close on escape key
        const handleEscape = (e) => {
            if (e.key === 'Escape') {
                closeFileViewer();
                document.removeEventListener('keydown', handleEscape);
            }
        };
        document.addEventListener('keydown', handleEscape);
        
        // Close on background click
        modal.addEventListener('click', (e) => {
            if (e.target === modal) {
                closeFileViewer();
                document.removeEventListener('keydown', handleEscape);
            }
        });
    }

    function openTextEditor(path, content, mime) {
        const modal = document.createElement('div');
        modal.id = 'file-viewer-modal';
        modal.style.cssText = `
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1100;
        `;

        modal.innerHTML = `
            <div style="background: var(--ub-dark); border: 2px solid var(--ub-orange); border-radius: 12px; padding: 1rem; max-width: 1000px; width: 95%; max-height: 90vh; overflow: hidden;">
                <div style="display:flex; justify-content: space-between; align-items:center; gap: 0.5rem; margin-bottom: 0.75rem;">
                    <h3 style="color: var(--ub-orange); margin: 0;">üìù Editor: ${path}</h3>
                    <div style="display:flex; gap: 0.5rem;">
                        <button onclick="saveTextEditor('${path}')" class="btn-ub" style="padding: 0.4rem 0.8rem;">üíæ Guardar</button>
                        <button onclick="closeFileViewer()" style="background: none; border: none; color: var(--ub-light); font-size: 1.5rem; cursor: pointer;">&times;</button>
                    </div>
                </div>
                <textarea id="text-editor-content" style="flex:1; background: rgba(255,255,255,0.05); border: 1px solid var(--ub-gray); color: var(--ub-light); padding: 0.75rem; border-radius: 6px; font-family: 'Courier New', monospace; font-size: 14px; resize: none; overflow-y: auto; white-space: pre; tab-size: 4;">${content}</textarea>
            </div>
        `;

        document.body.appendChild(modal);
        
        // Focus on textarea
        setTimeout(() => {
            const textarea = document.getElementById('text-editor-content');
            if (textarea) {
                textarea.focus();
                textarea.setSelectionRange(textarea.value.length, textarea.value.length);
            }
        }, 100);
    }

    async function saveTextEditor(path) {
        const textarea = document.getElementById('text-editor-content');
        if (!textarea) return;

        try {
            const response = await fetch('/api/files/write', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ 
                    path: path, 
                    content: textarea.value 
                })
            });
            const data = await parseJSONResponse(response);
            
            if (data.success) {
                alert('‚úÖ Archivo guardado exitosamente');
            } else {
                alert(`‚ùå Error al guardar: ${data.error}`);
            }
        } catch (error) {
            alert(`‚ùå Error de conexi√≥n: ${error.message}`);
        }
    }

    // Terminal Functions

    function createRealTerminalModal() {
        const modal = document.createElement('div');
        modal.style.cssText = `
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        `;

        modal.innerHTML = `
            <div style="background: var(--ub-dark); border: 2px solid var(--ub-orange); border-radius: 12px; padding: 1rem; max-width: 800px; width: 95%; max-height: 90vh; overflow: hidden;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                    <h3 style="color: var(--ub-orange); margin: 0;">üñ•Ô∏è Terminal Ubuntu Touch - Shell del Dispositivo</h3>
                    <div style="display:flex; gap: 0.5rem; align-items:center;">
                        <button onclick="openRootPrompt()" class="btn-ub" style="padding: 0.5rem 0.75rem;">Root</button>
                        <button onclick="closeTerminal()" style="background: none; border: none; color: var(--ub-light); font-size: 1.5rem; cursor: pointer;">&times;</button>
                    </div>
                </div>
                <div style="background: rgba(233, 84, 32, 0.1); border: 1px solid var(--ub-orange); border-radius: 8px; padding: 0.75rem; margin-bottom: 1rem; font-size: 0.9rem;">
                    <strong>Comandos √∫tiles:</strong> 
                    <code style="background: rgba(0,0,0,0.3); padding: 2px 6px; border-radius: 3px;">ls -la</code> ‚Ä¢ 
                    <code style="background: rgba(0,0,0,0.3); padding: 2px 6px; border-radius: 3px;">ps aux</code> ‚Ä¢ 
                    <code style="background: rgba(0,0,0,0.3); padding: 2px 6px; border-radius: 3px;">getprop</code>
                </div>
                <div id="terminal-output" style="background: #000; color: #0f0; padding: 1rem; border-radius: 8px; height: 400px; overflow-y: auto; font-family: 'Courier New', monospace; font-size: 14px; line-height: 1.4; margin-bottom: 1rem; white-space: pre-wrap;"></div>
                <div style="display: flex; gap: 0.5rem;">
                    <input type="text" id="terminal-command" placeholder="Escribe un comando del shell del dispositivo..." style="flex: 1; background: rgba(255,255,255,0.1); border: 1px solid var(--ub-gray); color: var(--ub-light); padding: 0.75rem; border-radius: 4px; font-family: 'Courier New', monospace;">
                    <button onclick="sendTerminalCommand()" class="btn-ub">Enviar</button>
                </div>
                <div style="margin-top: 0.5rem; font-size: 0.8rem; opacity: 0.7;">
                    Estado: <span id="device-status-terminal">Verificando...</span> | 
                    Sesi√≥n: <span id="session-id-terminal">No iniciada</span>
                </div>
            </div>
        `;
        
        document.body.appendChild(modal);
        
        // Initialize terminal
        initializeTerminal();
        
        // Focus on input
        setTimeout(() => {
            document.getElementById('terminal-command').focus();
        }, 100);

        // Handle Enter key
        document.getElementById('terminal-command').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                sendTerminalCommand();
            }
        });
    }

    async function initializeTerminal() {
        try {
            // Create terminal session
            const response = await fetch('/api/terminal/create', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({})
            });
            
            const data = await parseJSONResponse(response);
            
            if (data.success) {
                terminalSessionId = data.session_id;
                document.getElementById('device-status-terminal').textContent = 'Conectado al dispositivo';
                document.getElementById('session-id-terminal').textContent = data.session_id.substring(0, 12) + '...';
                
                // Start polling for output
                terminalInterval = setInterval(pollTerminalOutput, 500);
                
                // Start with empty output
                const output = document.getElementById('terminal-output');
                output.textContent = '';
            } else {
                document.getElementById('device-status-terminal').textContent = 'Error: ' + data.error;
                document.getElementById('session-id-terminal').textContent = 'N/A';
                document.getElementById('terminal-output').textContent = 'Error al conectar terminal: ' + data.error;
            }
        } catch (error) {
            console.error('Error initializing terminal:', error);
            document.getElementById('device-status-terminal').textContent = 'Error de conexi√≥n';
            document.getElementById('session-id-terminal').textContent = 'N/A';
            document.getElementById('terminal-output').textContent = 'Error al inicializar terminal';
        }
    }

    async function sendTerminalCommand() {
        const commandInput = document.getElementById('terminal-command');
        const output = document.getElementById('terminal-output');
        
        if (!commandInput || !terminalSessionId) return;

        const command = commandInput.value.trim();
        if (!command) return;
        
        // Send command to terminal (without \r\n since manager adds it)
        try {
            const response = await fetch(`/api/terminal/${terminalSessionId}/write`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ input: command })
            });
            
            const data = await parseJSONResponse(response);
            
            if (!data.success) {
                output.textContent += `Error: ${data.error}\r\n`;
            }
        } catch (error) {
            output.textContent += `Error de conexi√≥n: ${error.message}\r\n`;
        }

        // Clear input and scroll to bottom
        commandInput.value = '';
        output.scrollTop = output.scrollHeight;
    }

    async function pollTerminalOutput() {
        if (!terminalSessionId) return;
        
        try {
            const response = await fetch(`/api/terminal/${terminalSessionId}/output`);
            const data = await parseJSONResponse(response);
            
            if (data.success && data.output) {
                const output = document.getElementById('terminal-output');
                let chunk = data.output;

                // Strip terminal control sequences (ANSI/OSC) that can show up as "0;user@host"
                // OSC: ESC ] ... BEL or ESC \
                chunk = chunk.replace(/\x1b\][\s\S]*?(?:\x07|\x1b\\)/g, '');
                // CSI: ESC [ ... letter
                chunk = chunk.replace(/\x1b\[[0-9;?]*[ -/]*[@-~]/g, '');
                // Fallback: sometimes title text leaks without the ESC prefix
                chunk = chunk.replace(/(^|\r?\n)0;[^\r\n]*?(?=(\r?\n|$))/g, '$1');

                // Simplify prompt: user@host:/path$ -> user$
                // Also handles root@host:/path# -> root#
                chunk = chunk.replace(/([a-zA-Z0-9_-]+)@[^\s:]+:[^\r\n$#]*([\$#])/g, '$1$2');

                output.textContent += chunk;
                output.scrollTop = output.scrollHeight;
                
                // Update status if session became inactive
                if (!data.active) {
                    document.getElementById('device-status-terminal').textContent = 'Desconectado';
                    clearInterval(terminalInterval);
                    terminalInterval = null;
                }
            }
        } catch (error) {
            console.error('Error polling terminal:', error);
        }
    }

    function closeTerminal() {
        if (terminalInterval) {
            clearInterval(terminalInterval);
            terminalInterval = null;
        }
        
        if (terminalSessionId) {
            // Close terminal session
            fetch(`/api/terminal/${terminalSessionId}/close`, {
                method: 'POST'
            }).catch(console.error);
            terminalSessionId = null;
        }
        
        // Remove modal
        const modal = document.querySelector('div[style*="position: fixed"]');
        if (modal) {
            modal.remove();
        }
    }

    function openRootPrompt() {
        if (!terminalSessionId) return;

        const existing = document.getElementById('root-prompt-modal');
        if (existing) existing.remove();

        const modal = document.createElement('div');
        modal.id = 'root-prompt-modal';
        modal.style.cssText = `
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.75);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1100;
        `;

        modal.innerHTML = `
            <div style="background: var(--ub-dark); border: 2px solid var(--ub-orange); border-radius: 12px; padding: 2rem; max-width: 400px; width: 90%;">
                <h3 style="color: var(--ub-orange); margin: 0 0 1rem 0;">üîê Acceso Root</h3>
                <p style="margin-bottom: 1rem; opacity: 0.9;">Ingresa la contrase√±a de usuario para elevar privilegios a root:</p>
                <input type="password" id="root-password" placeholder="Contrase√±a de usuario" style="width: 100%; background: rgba(255,255,255,0.1); border: 1px solid var(--ub-gray); color: var(--ub-light); padding: 0.75rem; border-radius: 6px; margin-bottom: 1rem; font-family: inherit;">
                <div style="display: flex; gap: 0.5rem;">
                    <button onclick="submitRootAccess()" class="btn-ub" style="flex: 1;">Ejecutar sudo</button>
                    <button onclick="closeRootPrompt()" class="btn-ub" style="background: #666; flex: 1;">Cancelar</button>
                </div>
            </div>
        `;

        document.body.appendChild(modal);
        
        // Focus on password input
        setTimeout(() => {
            document.getElementById('root-password').focus();
        }, 100);
    }

    async function submitRootAccess() {
        const password = document.getElementById('root-password').value;
        if (!password) return;

        try {
            const response = await fetch(`/api/terminal/${terminalSessionId}/write`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ input: `echo '${password}' | sudo -S su` })
            });
            
            const data = await parseJSONResponse(response);
            if (data.success) {
                closeRootPrompt();
                // Add visual feedback
                const output = document.getElementById('terminal-output');
                output.textContent += '\r\n[ROOT] Elevando privilegios...\r\n';
            }
        } catch (error) {
            alert('Error al elevar privilegios: ' + error.message);
        }
    }

    function closeRootPrompt() {
        const modal = document.getElementById('root-prompt-modal');
        if (modal) modal.remove();
    }

    // Update Functions
    function checkForUpdates() {
        // Detect OS and choose appropriate script
        const isWindows = navigator.platform.indexOf('Win') !== -1;
        const isMac = navigator.platform.indexOf('Mac') !== -1;
        
        let updateCommand;
        let updateInstructions;
        
        if (isWindows) {
            updateCommand = 'update.bat';
            updateInstructions = `
                <div style="text-align: left; line-height: 1.6;">
                    <h4 style="color: var(--ub-orange); margin-bottom: 1rem;">üîÑ Actualizar UBTool (Windows)</h4>
                    <p><strong>Pasos para actualizar:</strong></p>
                    <ol style="margin-left: 1.5rem;">
                        <li>Cierra esta ventana de UBTool</li>
                        <li>Abre una terminal o s√≠mbolo del sistema</li>
                        <li>Navega al directorio de UBTool</li>
                        <li>Ejecuta: <code style="background: rgba(233,84,32,0.2); padding: 2px 6px; border-radius: 3px;">update.bat</code></li>
                        <li>Sigue las instrucciones del script</li>
                    </ol>
                    <p style="margin-top: 1rem;"><strong>Alternativa:</strong> Descarga manualmente desde <a href="https://github.com/lukasgaleano/UBTool/releases" target="_blank" style="color: var(--ub-orange);">GitHub Releases</a></p>
                </div>
            `;
        } else {
            updateCommand = './update.sh';
            updateInstructions = `
                <div style="text-align: left; line-height: 1.6;">
                    <h4 style="color: var(--ub-orange); margin-bottom: 1rem;">üîÑ Actualizar UBTool (Linux/macOS)</h4>
                    <p><strong>Pasos para actualizar:</strong></p>
                    <ol style="margin-left: 1.5rem;">
                        <li>Cierra esta ventana de UBTool</li>
                        <li>Abre una terminal</li>
                        <li>Navega al directorio de UBTool</li>
                        <li>Ejecuta: <code style="background: rgba(233,84,32,0.2); padding: 2px 6px; border-radius: 3px;">chmod +x update.sh && ./update.sh</code></li>
                        <li>Sigue las instrucciones del script</li>
                    </ol>
                    <p style="margin-top: 1rem;"><strong>Alternativa:</strong> Descarga manualmente desde <a href="https://github.com/lukasgaleano/UBTool/releases" target="_blank" style="color: var(--ub-orange);">GitHub Releases</a></p>
                </div>
            `;
        }
        
        // Create modal
        const modal = document.createElement('div');
        modal.style.cssText = `
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        `;
        
        modal.innerHTML = `
            <div style="background: var(--ub-dark); border: 2px solid var(--ub-orange); border-radius: 12px; padding: 2rem; max-width: 600px; width: 90%; max-height: 80vh; overflow-y: auto;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                    <h3 style="color: var(--ub-orange); margin: 0;">üîÑ Actualizar UBTool</h3>
                    <button onclick="this.closest('div[style*=position]').remove()" style="background: none; border: none; color: var(--ub-light); font-size: 1.5rem; cursor: pointer;">&times;</button>
                </div>
                ${updateInstructions}
            </div>
        `;
        
        document.body.appendChild(modal);
        
        // Close sidebar
        if (isSidebarOpen) {
            toggleSidebar();
        }
    }

    // Note: Development environment preparation moved to dedicated /dev-env page

    // Note: Apps management moved to dedicated /apps page

    function showDeviceInfo() {
        // Scroll to device info section
        const deviceSection = document.querySelector('.hero-section');
        if (deviceSection) {
            deviceSection.scrollIntoView({ behavior: 'smooth' });
        }
        // Close sidebar after navigation
        if (isSidebarOpen) {
            toggleSidebar();
        }
    }

    function rebootDevice() {
        if (confirm('¬øEst√°s seguro de que quieres reiniciar el dispositivo?')) {
            // Implement reboot functionality
            alert('Reiniciando dispositivo - Esta funci√≥n estar√° disponible pr√≥ximamente');
        }
        // Close sidebar after action
        if (isSidebarOpen) {
            toggleSidebar();
        }
    }

    // Web App Creation Modal
    function createWebAppModal() {
        // Check if modal already exists
        const existingModal = document.getElementById('webapp-create-modal');
        if (existingModal) {
            existingModal.remove();
        }

        const modal = document.createElement('div');
        modal.id = 'webapp-create-modal';
        modal.style.cssText = `
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        `;

        modal.innerHTML = `
            <div style="background: var(--ub-dark); border: 2px solid var(--ub-orange); border-radius: 12px; padding: 2rem; max-width: 600px; width: 90%; max-height: 90vh; overflow-y: auto;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                    <h3 style="color: var(--ub-orange); margin: 0;" data-i18n="webapps.create.title">üöÄ Crear Nueva WebApp</h3>
                    <button onclick="closeWebAppModal()" style="background: none; border: none; color: var(--ub-light); font-size: 1.5rem; cursor: pointer;">&times;</button>
                </div>
                
                <form id="webapp-form" onsubmit="createWebApp(event)">
                    <div style="margin-bottom: 1.5rem;">
                        <label style="display: block; margin-bottom: 0.5rem; color: var(--ub-light); font-weight: 500;" data-i18n="webapps.create.name">
                            Nombre de la App:
                        </label>
                        <input 
                            type="text" 
                            id="webapp-name" 
                            data-i18n-placeholder="webapps.create.name_ph"
                            placeholder="mi_app" 
                            required
                            title="Debe comenzar con una letra y solo puede contener letras, n√∫meros, guiones y guiones bajos"
                            style="width: 100%; background: rgba(255,255,255,0.1); border: 1px solid var(--ub-gray); color: var(--ub-light); padding: 0.75rem; border-radius: 6px; font-family: inherit;"
                        />
                        <small style="color: var(--ub-gray); font-size: 0.8rem; margin-top: 0.25rem; display: block;" data-i18n="webapps.create.name_hint">
                            Ej: mi_app, blog-todo, api_rest
                        </small>
                    </div>
                    
                    <div style="margin-bottom: 1.5rem;">
                        <label style="display: block; margin-bottom: 0.5rem; color: var(--ub-light); font-weight: 500;" data-i18n="webapps.create.framework">
                            Framework/Servidor:
                        </label>
                        <select 
                            id="webapp-framework" 
                            required
                            style="width: 100%; background: rgba(255,255,255,0.1); border: 1px solid var(--ub-gray); color: var(--ub-light); padding: 0.75rem; border-radius: 6px; font-family: inherit;"
                        >
                            <option value="" data-i18n="webapps.create.framework_ph">Selecciona un framework...</option>
                            <optgroup label="Frameworks Ligeros (Recomendado)">
                                <option value="microdot">üöÄ Microdot (Recomendado para UT)</option>
                                <option value="flask">üå∂Ô∏è Flask</option>
                                <option value="fastapi">‚ö° FastAPI</option>
                            </optgroup>
                            <optgroup label="Frameworks Completos">
                                <option value="django">üé∏ Django</option>
                                <option value="bottle">üçæ Bottle</option>
                            </optgroup>
                            <optgroup label="Servidores Est√°ticos">
                                <option value="http-server">üìÅ Servidor HTTP Est√°tico</option>
                                <option value="nodejs">üü¢ Node.js Express</option>
                                <option value="react">‚öõÔ∏è React</option>
                                <option value="vue">üíö Vue.js</option>
                            </optgroup>
                        </select>
                        <small style="color: var(--ub-gray); font-size: 0.8rem; margin-top: 0.25rem; display: block;" data-i18n="webapps.create.framework_hint">
                            Microdot es optimizado para Ubuntu Touch
                        </small>
                    </div>
                    
                    <div style="margin-bottom: 1.5rem;">
                        <label style="display: block; margin-bottom: 0.5rem; color: var(--ub-light); font-weight: 500;" data-i18n="webapps.create.icon">
                            Icono de la App (opcional):
                        </label>
                        <input 
                            type="file" 
                            id="webapp-icon" 
                            accept="image/*"
                            style="width: 100%; background: rgba(255,255,255,0.1); border: 1px solid var(--ub-gray); color: var(--ub-light); padding: 0.75rem; border-radius: 6px; font-family: inherit;"
                        />
                        <small style="color: var(--ub-gray); font-size: 0.8rem; margin-top: 0.25rem; display: block;" data-i18n="webapps.create.icon_hint">
                            Formatos: PNG, JPG, SVG. La imagen se guardar√° en static/images/
                        </small>
                    </div>
                    
                    <div style="margin-bottom: 1.5rem;">
                        <div style="background: rgba(233,84,32,0.1); border: 1px solid var(--ub-orange); border-radius: 8px; padding: 1rem;">
                            <h5 style="color: var(--ub-orange); margin: 0 0 0.5rem 0; font-size: 0.9rem;">üåç Entorno Virtual Global</h5>
                            <p style="margin: 0; color: var(--ub-light); font-size: 0.85rem; line-height: 1.4;">
                                Esta app usar√° el entorno virtual global compartido configurado en UBTool, optimizando el uso de recursos y dependencias.
                            </p>
                        </div>
                    </div>
                    
                    <div id="webapp-create-status" style="margin-bottom: 1rem; min-height: 1.5rem;"></div>
                    
                    <div style="display: flex; gap: 1rem;">
                        <button 
                            type="submit" 
                            id="create-webapp-btn"
                            data-i18n="webapps.create.submit"
                            style="flex: 1; background: var(--ub-orange); color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 6px; cursor: pointer; font-weight: bold; transition: all 0.3s ease;"
                        >
                            üöÄ Crear WebApp
                        </button>
                        <button 
                            type="button" 
                            onclick="closeWebAppModal()"
                            data-i18n="webapps.create.cancel"
                            style="flex: 1; background: rgba(255,255,255,0.1); color: var(--ub-light); border: 1px solid var(--ub-orange); padding: 0.75rem 1.5rem; border-radius: 6px; cursor: pointer; transition: all 0.3s ease;"
                        >
                            Cancelar
                        </button>
                    </div>
                </form>
            </div>
        `;

        document.body.appendChild(modal);
        
        // Apply translations to modal elements
        applyTranslations(currentLanguage);
        
        // Focus on name input
        setTimeout(() => {
            document.getElementById('webapp-name').focus();
        }, 100);

        // Close sidebar
        if (isSidebarOpen) {
            toggleSidebar();
        }
    }

    function closeWebAppModal() {
        const modal = document.getElementById('webapp-create-modal');
        if (modal) {
            modal.remove();
        }
    }

    async function createWebApp(event) {
        event.preventDefault();
        
        const name = document.getElementById('webapp-name').value.trim();
        const framework = document.getElementById('webapp-framework').value;
        const iconInput = document.getElementById('webapp-icon');
        const statusDiv = document.getElementById('webapp-create-status');
        const submitBtn = document.getElementById('create-webapp-btn');
        
        if (!name || !framework) {
            statusDiv.innerHTML = `<p style="color: #f44336;">${UBTOOL_I18N[currentLanguage]['webapps.create.error_required'] || '‚ùå Por favor completa todos los campos requeridos'}</p>`;
            return;
        }
        
        // Disable button and show loading
        submitBtn.disabled = true;
        submitBtn.textContent = UBTOOL_I18N[currentLanguage]['webapps.create.creating'] || '‚è≥ Creando...';
        statusDiv.innerHTML = `<p style="color: var(--ub-orange);">${UBTOOL_I18N[currentLanguage]['webapps.create.status_creating'] || 'üîÑ Creando aplicaci√≥n web...'}</p>`;
        
        // Validate file size
        if (iconInput.files && iconInput.files[0]) {
            const file = iconInput.files[0];
            const maxSize = 5 * 1024 * 1024; // 5MB limit for icon
            if (file.size > maxSize) {
                statusDiv.innerHTML = `<p style="color: #f44336;">‚ùå El archivo es demasiado grande. M√°ximo 5MB para iconos.</p>`;
                submitBtn.disabled = false;
                submitBtn.textContent = UBTOOL_I18N[currentLanguage]['webapps.create.submit'] || 'üöÄ Crear App';
                return;
            }
        }
        
        try {
            // Create FormData to handle file upload
            const formData = new FormData();
            formData.append('app_name', name);
            formData.append('framework', framework);
            
            // Add icon file if selected
            if (iconInput.files && iconInput.files[0]) {
                formData.append('icon', iconInput.files[0]);
            }
            
            const response = await fetch('/api/devtools/create_env', {
                method: 'POST',
                body: formData
            });
            
            const data = await parseJSONResponse(response);
            
            if (data.success) {
                statusDiv.innerHTML = `
                    <div style="background: rgba(76,175,80,0.1); border: 1px solid #4CAF50; border-radius: 6px; padding: 1rem; margin-bottom: 1rem;">
                        <h4 style="color: #4CAF50; margin: 0 0 0.5rem 0;">‚úÖ ${data.message}</h4>
                        <p style="margin: 0; color: var(--ub-light); font-size: 0.9rem;">
                            <strong>Ruta:</strong> ${data.app_path || 'N/A'}<br>
                            <strong>Framework:</strong> ${data.framework || 'N/A'}<br>
                            ${data.global_venv ? `<strong>Entorno Global:</strong> ${data.global_venv}<br>` : ''}
                            ${data.next_steps ? `<strong>Siguientes pasos:</strong><br>${data.next_steps.join('<br>')}` : ''}
                        </p>
                    </div>
                `;
                
                // Reset form
                document.getElementById('webapp-form').reset();
                submitBtn.textContent = UBTOOL_I18N[currentLanguage]['webapps.create.success'] || '‚úÖ Creado Exitosamente';
                submitBtn.style.background = '#4CAF50';
                
                // Auto-close modal after 5 seconds (longer to show next steps)
                setTimeout(() => {
                    closeWebAppModal();
                    // Note: Apps list refresh is now handled by the dedicated /apps page
                }, 5000);
                
            } else {
                statusDiv.innerHTML = `<p style="color: #f44336;">‚ùå Error: ${data.error}</p>`;
                submitBtn.disabled = false;
                submitBtn.textContent = UBTOOL_I18N[currentLanguage]['webapps.create.submit'] || 'üöÄ Crear WebApp';
            }
        } catch (error) {
            statusDiv.innerHTML = `<p style="color: #f44336;">‚ùå Error de conexi√≥n: ${error.message}</p>`;
            submitBtn.disabled = false;
            submitBtn.textContent = UBTOOL_I18N[currentLanguage]['webapps.create.submit'] || 'üöÄ Crear WebApp';
        }
    }

    // Initialize on page load
    window.onload = async function() {
        // Initialize language
        initializeLanguage();
        
        // Check device connection
        checkDevice();
        
        // Check for updates
        checkForUpdatesBackground();
        
        // Initialize sidebar
        initializeSidebar();
    };

    // Background version check
    async function checkForUpdatesBackground() {
        try {
            const response = await fetch('/api/version/check');
            const data = await parseJSONResponse(response);
            
            if (data.success) {
                // Update current version display
                const currentVersionElements = document.querySelectorAll('#current-version, #current-version-footer');
                currentVersionElements.forEach(el => {
                    el.textContent = data.current_version;
                });
                
                // Show update notification if available
                if (data.has_update) {
                    const notification = document.getElementById('update-notification');
                    const latestVersionElement = document.getElementById('latest-version');
                    
                    if (notification && latestVersionElement) {
                        latestVersionElement.textContent = data.latest_version;
                        notification.style.display = 'block';
                        
                        console.log(`Nueva versi√≥n disponible: ${data.latest_version} (actual: ${data.current_version})`);
                    }
                }
            } else {
                console.warn('No se pudo verificar la versi√≥n:', data.error);
            }
        } catch (error) {
            console.error('Error verificando actualizaciones:', error);
        }
    }

    function initializeLanguage() {
        const lang = getCurrentLanguage();
        applyTranslations(lang);
        
        const langToggle = document.getElementById('lang-toggle');
        if (langToggle) {
            langToggle.addEventListener('click', toggleLanguage);
        }
    }

    function initializeSidebar() {
        const yearEl = document.getElementById('footer-year');
        if (yearEl) {
            yearEl.textContent = String(new Date().getFullYear());
        }
        
        checkDevice();
    };
    
    // Auto-refresh device status every 30 seconds
    setInterval(checkDevice, 30000);
</script>
{% endblock %}
