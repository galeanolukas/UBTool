{% extends "base.html" %}

{% block title %}UBTool - Ubuntu Touch Connection Tool{% endblock %}

{% block extra_css %}
<!-- Sidebar overlay -->
<div id="sidebar-overlay" class="sidebar-overlay" onclick="toggleSidebar()"></div>
{% endblock %}

{% block content %}
<!-- Hero Section -->
<section class="hero-section" style="background: linear-gradient(135deg, var(--ub-dark) 0%, #2c2c2c 100%); padding: 4rem 0; text-align: center;">
    <div class="w3-content" style="max-width: 1200px; margin: 0 auto; padding: 0 2rem;">
        <h1 class="hero-title" style="color: var(--ub-orange); margin-bottom: 1rem;">
            üöÄ UBTool
        </h1>
        <p class="hero-subtitle" style="color: var(--ub-light); opacity: 0.9;">
            <span data-i18n="hero.subtitle">Conecta y gestiona dispositivos Ubuntu Touch v√≠a ADB</span>
        </p>
        
        <!-- Device Status Card -->
        <div style="display: flex; justify-content: center; margin-top: 3rem;">
            <div class="device-card" style="text-align: center; max-width: 600px; width: 100%;">
                <h3 class="w3-text-orange" data-i18n="device.title">Estado del Dispositivo</h3>
                <div id="device-info" style="text-align: left;">
                    <p style="color: #666;" data-i18n="device.loading">Cargando informaci√≥n del dispositivo...</p>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- Features Section -->
<section class="features-section" style="padding: 4rem 0; background: rgba(0,0,0,0.2);">
    <div class="w3-content" style="max-width: 1200px; margin: 0 auto; padding: 0 2rem;">
        <div style="text-align: center; margin-bottom: 3rem;">
            <h2 class="hero-title w3-text-orange" style="margin-bottom: 1rem;" data-i18n="features.title">Caracter√≠sticas</h2>
            <p style="opacity: 0.8; font-size: 1.1rem;" data-i18n="features.subtitle">Descubre las potentes funcionalidades de UBTool</p>
        </div>
        
        <div style="display: flex; justify-content: center; align-items: stretch; gap: 3rem; margin-bottom: 3rem; flex-wrap: wrap;">
            <div style="flex: 1; min-width: 300px; max-width: 350px;">
                <div class="device-card" style="text-align: center; height: 100%; padding: 2rem;">
                    <div style="font-size: 3rem; margin-bottom: 1.5rem;">üîó</div>
                    <h3 style="color: var(--ub-orange); margin-bottom: 1.5rem;" data-i18n="features.adb.title">Conexi√≥n ADB</h3>
                    <p style="line-height: 1.6; opacity: 0.9; font-size: 1rem;" data-i18n="features.adb.desc">Conecta y gestiona dispositivos Ubuntu Touch v√≠a ADB con interfaz web moderna</p>
                </div>
            </div>
            
            <div style="flex: 1; min-width: 300px; max-width: 350px;">
                <div class="device-card" style="text-align: center; height: 100%; padding: 2rem;">
                    <div style="font-size: 3rem; margin-bottom: 1.5rem;">üì±</div>
                    <h3 style="color: var(--ub-orange); margin-bottom: 1.5rem;" data-i18n="features.devices.title">Gesti√≥n de Dispositivos</h3>
                    <p style="line-height: 1.6; opacity: 0.9; font-size: 1rem;" data-i18n="features.devices.desc">Visualiza y controla m√∫ltiples dispositivos conectados simult√°neamente</p>
                </div>
            </div>
            
            <div style="flex: 1; min-width: 300px; max-width: 350px;">
                <div class="device-card" style="text-align: center; height: 100%; padding: 2rem;">
                    <div style="font-size: 3rem; margin-bottom: 1.5rem;">üåê</div>
                    <h3 style="color: var(--ub-orange); margin-bottom: 1.5rem;" data-i18n="features.web.title">Interfaz Web</h3>
                    <p style="line-height: 1.6; opacity: 0.9; font-size: 1rem;" data-i18n="features.web.desc">Accede desde cualquier navegador moderno con dise√±o responsive y temas Ubuntu Touch</p>
                </div>
            </div>
        </div>
        
        <!-- Second Row of Features -->
        <div style="display: flex; justify-content: center; align-items: stretch; gap: 3rem; flex-wrap: wrap;">
            <div style="flex: 1; min-width: 300px; max-width: 350px;">
                <div class="device-card" style="text-align: center; height: 100%; padding: 2rem;">
                    <div style="font-size: 3rem; margin-bottom: 1.5rem;">üñ•Ô∏è</div>
                    <h3 style="color: var(--ub-orange); margin-bottom: 1.5rem;" data-i18n="features.terminal.title">Terminal Integrada</h3>
                    <p style="line-height: 1.6; opacity: 0.9; font-size: 1rem;" data-i18n="features.terminal.desc">Ejecuta comandos ADB directamente desde la interfaz web</p>
                </div>
            </div>
            
            <div style="flex: 1; min-width: 300px; max-width: 350px;">
                <div class="device-card" style="text-align: center; height: 100%; padding: 2rem;">
                    <div style="font-size: 3rem; margin-bottom: 1.5rem;">üìÅ</div>
                    <h3 style="color: var(--ub-orange); margin-bottom: 1.5rem;">File Manager</h3>
                    <p style="line-height: 1.6; opacity: 0.9; font-size: 1rem;">Explora y gestiona archivos del dispositivo con interfaz intuitiva</p>
                </div>
            </div>
            
            <div style="flex: 1; min-width: 300px; max-width: 350px;">
                <div class="device-card" style="text-align: center; height: 100%; padding: 2rem;">
                    <div style="font-size: 3rem; margin-bottom: 1.5rem;">üöÄ</div>
                    <h3 style="color: var(--ub-orange); margin-bottom: 1.5rem;">Web Apps</h3>
                    <p style="line-height: 1.6; opacity: 0.9; font-size: 1rem;">Crea y gestiona aplicaciones web con Click y prepara para deployment</p>
                </div>
            </div>
        </div>
    </div>
</section>
{% endblock %}

{% block scripts %}
<script>
    // Internationalization
    const UBTOOL_I18N = {
        'es': {
            'status.checking': 'Verificando...',
            'status.connected': 'Conectado',
            'status.disconnected': 'Desconectado',
            'device.title': 'Estado del Dispositivo',
            'device.loading': 'Cargando informaci√≥n del dispositivo...',
            'hero.subtitle': 'Conecta y gestiona dispositivos Ubuntu Touch v√≠a ADB',
            'tools.title': 'Herramientas R√°pidas',
            'tools.subtitle': 'Acceso r√°pido a funciones ADB',
            'tools.shell': 'üñ•Ô∏è Shell',
            'tools.reboot': 'üîÑ Reiniciar',
            'webapps.title': 'Apps Web',
            'webapps.prepare': 'Preparar entorno global (pip/virtualenv)',
            'webapps.name': 'Nombre:',
            'webapps.name_ph': 'mi_app',
            'webapps.framework': 'Framework:',
            'webapps.create': 'Crear WebApp',
            'webapps.installed.title': 'Apps Instaladas',
            'webapps.installed.refresh': 'üîÑ Actualizar Lista',
            'webapps.installed.loading': 'Cargando...',
            'webapps.installed.start': '‚ñ∂Ô∏è Iniciar',
            'webapps.installed.stop': '‚èπÔ∏è Detener',
            'webapps.installed.delete': 'üóëÔ∏è Eliminar',
            'webapps.installed.prepare': 'üöÄ Preparar',
            'webapps.installed.no_apps': 'No hay apps instaladas',
            'files.title': 'üìÅ File Manager',
            'files.subtitle': 'Explora archivos del dispositivo',
            'files.open': 'Abrir',
            'features.title': 'Caracter√≠sticas',
            'features.adb.title': 'Conexi√≥n ADB',
            'features.adb.desc': 'Conecta y gestiona dispositivos Ubuntu Touch v√≠a ADB con interfaz web moderna',
            'features.devices.title': 'Gesti√≥n de Dispositivos',
            'features.devices.desc': 'Visualiza y controla m√∫ltiples dispositivos conectados simult√°neamente',
            'features.web.title': 'Interfaz Web',
            'features.web.desc': 'Accede desde cualquier navegador moderno con dise√±o responsive y temas Ubuntu Touch',
            'footer.about': 'Acerca de UBTool',
            'footer.description': 'Herramienta moderna para gestionar dispositivos Ubuntu Touch v√≠a ADB con interfaz web intuitiva.',
            'footer.support': 'Apoya el proyecto',
            'footer.buy_coffee': 'Buy Me a Coffee',
            'footer.rights': 'Todos los derechos reservados.'
        },
        'en': {
            'status.checking': 'Checking...',
            'status.connected': 'Connected',
            'status.disconnected': 'Disconnected',
            'device.title': 'Device Status',
            'device.loading': 'Loading device information...',
            'hero.subtitle': 'Connect and manage Ubuntu Touch devices via ADB',
            'tools.title': 'Quick Tools',
            'tools.subtitle': 'Quick access to ADB features',
            'tools.shell': 'üñ•Ô∏è Shell',
            'tools.reboot': 'üîÑ Reboot',
            'webapps.title': 'Web Apps',
            'webapps.prepare': 'Prepare global environment (pip/virtualenv)',
            'webapps.name': 'Name:',
            'webapps.name_ph': 'my_app',
            'webapps.framework': 'Framework:',
            'webapps.create': 'Create WebApp',
            'webapps.installed.title': 'Installed Apps',
            'webapps.installed.refresh': 'üîÑ Refresh List',
            'webapps.installed.loading': 'Loading...',
            'webapps.installed.start': '‚ñ∂Ô∏è Start',
            'webapps.installed.stop': '‚èπÔ∏è Stop',
            'webapps.installed.delete': 'üóëÔ∏è Delete',
            'webapps.installed.prepare': 'üöÄ Prepare',
            'webapps.installed.no_apps': 'No installed apps',
            'files.title': 'üìÅ File Manager',
            'files.subtitle': 'Browse device files',
            'files.open': 'Open',
            'features.title': 'Features',
            'features.adb.title': 'ADB Connection',
            'features.adb.desc': 'Connect and manage Ubuntu Touch devices via ADB with a modern web UI',
            'features.devices.title': 'Device Management',
            'features.devices.desc': 'View and control multiple connected devices simultaneously',
            'features.web.title': 'Web Interface',
            'features.web.desc': 'Access from any modern browser with responsive design and Ubuntu Touch styling',
            'footer.about': 'About UBTool',
            'footer.description': 'Modern tool for managing Ubuntu Touch devices via ADB with intuitive web interface.',
            'footer.support': 'Support the project',
            'footer.buy_coffee': 'Buy Me a Coffee',
            'footer.rights': 'All rights reserved.'
        }
    };

    let currentLanguage = localStorage.getItem('ubtool_lang') || 'es';

    function getCurrentLanguage() {
        return currentLanguage;
    }

    function applyTranslations(lang) {
        currentLanguage = lang;
        localStorage.setItem('ubtool_lang', lang);
        
        document.querySelectorAll('[data-i18n]').forEach(element => {
            const key = element.getAttribute('data-i18n');
            if (UBTOOL_I18N[lang] && UBTOOL_I18N[lang][key]) {
                element.textContent = UBTOOL_I18N[lang][key];
            }
        });
        
        document.querySelectorAll('[data-i18n-placeholder]').forEach(element => {
            const key = element.getAttribute('data-i18n-placeholder');
            if (UBTOOL_I18N[lang] && UBTOOL_I18N[lang][key]) {
                element.placeholder = UBTOOL_I18N[lang][key];
            }
        });
        
        // Update language toggle button
        const langToggle = document.getElementById('lang-toggle');
        if (langToggle) {
            langToggle.textContent = lang === 'es' ? 'üåê EN' : 'üåê ES';
        }
    }

    function toggleLanguage() {
        const newLang = currentLanguage === 'es' ? 'en' : 'es';
        applyTranslations(newLang);
    }

    // Device status checking
    async function checkDevice() {
        try {
            const response = await fetch('/api/device/status');
            const data = await response.json();
            
            const statusIndicator = document.getElementById('status-indicator');
            const statusText = document.getElementById('status-text');
            const deviceInfo = document.getElementById('device-info');
            
            if (data.connected) {
                statusIndicator.className = 'status-connected';
                statusText.textContent = UBTOOL_I18N[currentLanguage]['status.connected'];
                
                // Load device info
                const infoResponse = await fetch('/api/device/info');
                const infoData = await infoResponse.json();
                
                if (infoData.success) {
                    const info = infoData.info;
                    const memory = info.memory || {};
                    const storage = info.storage || {};
                    const primaryStorage = storage.primary || {};
                    
                    deviceInfo.innerHTML = `
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
                            <div><strong>Modelo:</strong> ${info.model || 'N/A'}</div>
                            <div><strong>Versi√≥n:</strong> ${info.version || 'N/A'}</div>
                            <div><strong>SO:</strong> ${info.os_name || 'N/A'} ${info.os_version || ''}</div>
                            <div><strong>IP:</strong> ${info.ip_address || 'N/A'}</div>
                            <div><strong>Bater√≠a:</strong> ${info.battery || 'N/A'}</div>
                            <div><strong>RAM:</strong> ${memory.total || 'N/A'} (${memory.used || 'N/A'} usados)</div>
                            <div><strong>Almacenamiento:</strong> ${primaryStorage.size || 'N/A'} (${primaryStorage.used || 'N/A'} usados)</div>
                            <div><strong>Serial:</strong> ${info.serial || 'N/A'}</div>
                        </div>
                    `;
                }
            } else {
                statusIndicator.className = 'status-disconnected';
                statusText.textContent = UBTOOL_I18N[currentLanguage]['status.disconnected'];
                deviceInfo.innerHTML = `<p style="color: #f44336;">${data.error || 'No se puede conectar al dispositivo'}</p>`;
            }
        } catch (error) {
            console.error('Error checking device:', error);
            document.getElementById('status-text').textContent = 'Error';
        }
    }

    // Global functions for modals and tools
    function openTerminal() {
        createRealTerminalModal();
    }

    function openFileManager() {
        const modal = document.createElement('div');
        modal.id = 'file-manager-modal';
        modal.style.cssText = `
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        `;

        modal.innerHTML = `
            <div style="background: var(--ub-dark); border: 2px solid var(--ub-orange); border-radius: 12px; padding: 1rem; max-width: 900px; width: 95%; max-height: 90vh; overflow: hidden;">
                <div style="display:flex; justify-content: space-between; align-items:center; gap: 0.5rem; margin-bottom: 0.75rem;">
                    <h3 style="color: var(--ub-orange); margin: 0;">üìÅ File Manager</h3>
                    <button onclick="closeFileManager()" style="background: none; border: none; color: var(--ub-light); font-size: 1.5rem; cursor: pointer;">&times;</button>
                </div>
                <div style="display:flex; gap: 0.5rem; align-items:center; margin-bottom: 0.75rem;">
                    <button class="btn-ub" style="padding: 0.5rem 0.75rem;" onclick="fmGoUp()">‚¨ÜÔ∏è</button>
                    <input id="fm-path" type="text" style="flex:1; background: rgba(255,255,255,0.1); border: 1px solid var(--ub-gray); color: var(--ub-light); padding: 0.6rem; border-radius: 6px;" />
                    <button class="btn-ub" style="padding: 0.5rem 0.75rem;" onclick="fmGoToPath()">Ir</button>
                </div>
                <div id="fm-status" style="margin-bottom: 0.5rem; opacity: 0.9;"></div>
                <div id="fm-list" style="background: rgba(0,0,0,0.35); border: 1px solid var(--ub-gray); border-radius: 8px; padding: 0.5rem; height: 60vh; overflow-y: auto; font-family: 'Ubuntu', 'Arial', sans-serif;"></div>
            </div>
        `;

        document.body.appendChild(modal);
        document.getElementById('fm-path').value = fmCurrentPath;
        loadFileManagerPath(fmCurrentPath);
    }

    // File Manager Variables and Functions
    let fmCurrentPath = '/home/phablet';

    function closeFileManager() {
        const modal = document.getElementById('file-manager-modal');
        if (modal) modal.remove();
    }

    function fmGoUp() {
        if (!fmCurrentPath || fmCurrentPath === '/') {
            loadFileManagerPath('/');
            return;
        }
        const parent = fmCurrentPath.replace(/\/+$/, '').split('/').slice(0, -1).join('/') || '/';
        loadFileManagerPath(parent);
    }

    function fmGoToPath() {
        const p = (document.getElementById('fm-path').value || '').trim();
        if (!p) return;
        loadFileManagerPath(p);
    }

    async function loadFileManagerPath(path) {
        const status = document.getElementById('fm-status');
        const list = document.getElementById('fm-list');
        const pathInput = document.getElementById('fm-path');
        if (!status || !list || !pathInput) return;

        status.innerHTML = '<span class="loading-spinner"></span> Cargando...';
        list.innerHTML = '';

        try {
            const url = `/api/files/list?path=${encodeURIComponent(path)}`;
            const response = await fetch(url);
            const data = await response.json();

            if (!data.success) {
                status.innerHTML = `‚ùå ${data.error || 'Error al listar'}`;
                return;
            }

            const payload = data.data;
            fmCurrentPath = payload.path || path;
            pathInput.value = fmCurrentPath;
            status.textContent = fmCurrentPath;

            const entries = payload.entries || [];
            if (!entries.length) {
                list.innerHTML = '<div style="opacity:0.8; padding: 0.5rem;">(vac√≠o)</div>';
                return;
            }

            let html = '';
            for (const e of entries) {
                const name = e.name || '';
                const isDir = !!e.is_dir;
                const size = e.size_human || '';
                const rowStyle = 'display:flex; justify-content: space-between; gap: 0.75rem; padding: 0.5rem; border-radius: 6px; cursor: pointer;';
                const left = isDir ? `üìÅ ${name}` : `üìÑ ${name}`;
                html += `
                    <div style="${rowStyle}" onmouseover="this.style.background='rgba(233,84,32,0.10)'" onmouseout="this.style.background='transparent'" onclick="fmEntryClick(${isDir ? 'true' : 'false'}, '${encodeURIComponent(name)}')">
                        <div style="overflow:hidden; text-overflow: ellipsis; white-space: nowrap;">${left}</div>
                        <div style="opacity:0.8; white-space: nowrap;">${isDir ? '' : size}</div>
                    </div>
                `;
            }
            list.innerHTML = html;
        } catch (e) {
            status.innerHTML = `‚ùå Error: ${e.message}`;
        }
    }

    function fmEntryClick(isDir, encodedName) {
        const name = decodeURIComponent(encodedName || '');
        if (!name) return;
        if (isDir) {
            const base = (fmCurrentPath || '/').replace(/\/+$/, '');
            const next = (base === '' || base === '/') ? `/${name}` : `${base}/${name}`;
            loadFileManagerPath(next);
        } else {
            const base = (fmCurrentPath || '/').replace(/\/+$/, '');
            const fullPath = (base === '' || base === '/') ? `/${name}` : `${base}/${name}`;
            openFile(fullPath);
        }
    }

    function closeFileViewer() {
        const modal = document.getElementById('file-viewer-modal');
        if (modal) modal.remove();
    }

    async function openFile(path) {
        try {
            const res = await fetch(`/api/files/text?path=${encodeURIComponent(path)}`);
            const data = await res.json();
            if (data.success) {
                openTextEditor(path, data.content || '', data.mime || 'text/plain');
                return;
            }
        } catch (e) {
            // Fall back to viewer
        }

        openBinaryViewer(path);
    }

    function openBinaryViewer(path) {
        const modal = document.createElement('div');
        modal.id = 'file-viewer-modal';
        modal.style.cssText = `
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1100;
        `;

        const url = `/api/files/raw?path=${encodeURIComponent(path)}`;
        const ext = (path.split('.').pop() || '').toLowerCase();
        const isImage = ['png','jpg','jpeg','gif','bmp','webp','svg'].includes(ext);
        const isVideo = ['mp4','webm','ogg','mov','mkv','avi','3gp'].includes(ext);

        let body = '';
        if (isImage) {
            body = `<img src="${url}" style="max-width: 100%; max-height: 70vh; border-radius: 8px;" />`;
        } else if (isVideo) {
            body = `<video src="${url}" controls style="max-width: 100%; max-height: 70vh; border-radius: 8px;"></video>`;
        } else {
            body = `<div style="opacity:0.9; margin-bottom: 1rem;">Archivo: <code>${path}</code></div>
                    <a class="btn-ub" href="${url}" target="_blank" rel="noopener">Abrir/Descargar</a>`;
        }

        modal.innerHTML = `
            <div style="background: var(--ub-dark); border: 2px solid var(--ub-orange); border-radius: 12px; padding: 1rem; max-width: 1000px; width: 95%; max-height: 90vh; overflow: auto;">
                <div style="display:flex; justify-content: space-between; align-items:center; gap: 0.5rem; margin-bottom: 0.75rem;">
                    <h3 style="color: var(--ub-orange); margin: 0;">üëÅÔ∏è Viewer</h3>
                    <button onclick="closeFileViewer()" style="background: none; border: none; color: var(--ub-light); font-size: 1.5rem; cursor: pointer;">&times;</button>
                </div>
                ${body}
            </div>
        `;

        document.body.appendChild(modal);
    }

    function openTextEditor(path, content, mime) {
        const modal = document.createElement('div');
        modal.id = 'file-viewer-modal';
        modal.style.cssText = `
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1100;
        `;

        modal.innerHTML = `
            <div style="background: var(--ub-dark); border: 2px solid var(--ub-orange); border-radius: 12px; padding: 1rem; max-width: 1000px; width: 95%; max-height: 90vh; overflow: hidden; display: flex; flex-direction: column;">
                <div style="display:flex; justify-content: space-between; align-items:center; gap: 0.5rem; margin-bottom: 0.75rem;">
                    <h3 style="color: var(--ub-orange); margin: 0;">üìù Editor: ${path}</h3>
                    <div style="display:flex; gap: 0.5rem;">
                        <button onclick="saveTextEditor('${path}')" class="btn-ub" style="padding: 0.4rem 0.8rem; font-size: 0.9rem;">üíæ Guardar</button>
                        <button onclick="closeFileViewer()" style="background: none; border: none; color: var(--ub-light); font-size: 1.5rem; cursor: pointer;">&times;</button>
                    </div>
                </div>
                <textarea id="text-editor-content" style="flex:1; background: rgba(255,255,255,0.05); border: 1px solid var(--ub-gray); color: var(--ub-light); padding: 0.75rem; border-radius: 6px; font-family: 'Courier New', monospace; font-size: 14px; resize: none; overflow-y: auto; white-space: pre; tab-size: 4;">${content}</textarea>
            </div>
        `;

        document.body.appendChild(modal);
        
        // Focus on textarea
        setTimeout(() => {
            const textarea = document.getElementById('text-editor-content');
            if (textarea) {
                textarea.focus();
                textarea.setSelectionRange(textarea.value.length, textarea.value.length);
            }
        }, 100);
    }

    async function saveTextEditor(path) {
        const textarea = document.getElementById('text-editor-content');
        if (!textarea) return;

        try {
            const response = await fetch('/api/files/write', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ 
                    path: path, 
                    content: textarea.value 
                })
            });
            const data = await response.json();
            
            if (data.success) {
                alert('‚úÖ Archivo guardado exitosamente');
            } else {
                alert(`‚ùå Error al guardar: ${data.error}`);
            }
        } catch (error) {
            alert(`‚ùå Error de conexi√≥n: ${error.message}`);
        }
    }

    // Terminal Functions
    let terminalSessionId = null;
    let terminalInterval = null;

    function createRealTerminalModal() {
        const modal = document.createElement('div');
        modal.style.cssText = `
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        `;

        modal.innerHTML = `
            <div style="background: var(--ub-dark); border: 2px solid var(--ub-orange); border-radius: 12px; padding: 1rem; max-width: 800px; width: 95%; max-height: 90vh; overflow: hidden;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                    <h3 style="color: var(--ub-orange); margin: 0;">üñ•Ô∏è Terminal Ubuntu Touch - Shell del Dispositivo</h3>
                    <div style="display:flex; gap: 0.5rem; align-items:center;">
                        <button onclick="openRootPrompt()" class="btn-ub" style="padding: 0.5rem 0.75rem;">Root</button>
                        <button onclick="closeTerminal()" style="background: none; border: none; color: var(--ub-light); font-size: 1.5rem; cursor: pointer;">&times;</button>
                    </div>
                </div>
                <div style="background: rgba(233, 84, 32, 0.1); border: 1px solid var(--ub-orange); border-radius: 8px; padding: 0.75rem; margin-bottom: 1rem; font-size: 0.9rem;">
                    <strong>Comandos √∫tiles:</strong> 
                    <code style="background: rgba(0,0,0,0.3); padding: 2px 6px; border-radius: 3px;">ls -la</code> ‚Ä¢ 
                    <code style="background: rgba(0,0,0,0.3); padding: 2px 6px; border-radius: 3px;">ps aux</code> ‚Ä¢ 
                    <code style="background: rgba(0,0,0,0.3); padding: 2px 6px; border-radius: 3px;">getprop</code>
                </div>
                <div id="terminal-output" style="background: #000; color: #0f0; padding: 1rem; border-radius: 8px; height: 400px; overflow-y: auto; font-family: 'Courier New', monospace; font-size: 14px; line-height: 1.4; margin-bottom: 1rem; white-space: pre-wrap;"></div>
                <div style="display: flex; gap: 0.5rem;">
                    <input type="text" id="terminal-command" placeholder="Escribe un comando del shell del dispositivo..." style="flex: 1; background: rgba(255,255,255,0.1); border: 1px solid var(--ub-gray); color: var(--ub-light); padding: 0.75rem; border-radius: 4px; font-family: 'Courier New', monospace;">
                    <button onclick="sendTerminalCommand()" class="btn-ub">Enviar</button>
                </div>
                <div style="margin-top: 0.5rem; font-size: 0.8rem; opacity: 0.7;">
                    Estado: <span id="device-status-terminal">Verificando...</span> | 
                    Sesi√≥n: <span id="session-id-terminal">No iniciada</span>
                </div>
            </div>
        `;
        
        document.body.appendChild(modal);
        
        // Initialize terminal
        initializeTerminal();
        
        // Focus on input
        setTimeout(() => {
            document.getElementById('terminal-command').focus();
        }, 100);

        // Handle Enter key
        document.getElementById('terminal-command').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                sendTerminalCommand();
            }
        });
    }

    async function initializeTerminal() {
        try {
            // Create terminal session
            const response = await fetch('/api/terminal/create', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({})
            });
            
            const data = await response.json();
            
            if (data.success) {
                terminalSessionId = data.session_id;
                document.getElementById('device-status-terminal').textContent = 'Conectado al dispositivo';
                document.getElementById('session-id-terminal').textContent = data.session_id.substring(0, 12) + '...';
                
                // Start polling for output
                terminalInterval = setInterval(pollTerminalOutput, 500);
                
                // Start with empty output
                const output = document.getElementById('terminal-output');
                output.textContent = '';
            } else {
                document.getElementById('device-status-terminal').textContent = 'Error: ' + data.error;
                document.getElementById('session-id-terminal').textContent = 'N/A';
                document.getElementById('terminal-output').textContent = 'Error al conectar terminal: ' + data.error;
            }
        } catch (error) {
            console.error('Error initializing terminal:', error);
            document.getElementById('device-status-terminal').textContent = 'Error de conexi√≥n';
            document.getElementById('session-id-terminal').textContent = 'N/A';
            document.getElementById('terminal-output').textContent = 'Error al inicializar terminal';
        }
    }

    async function sendTerminalCommand() {
        const commandInput = document.getElementById('terminal-command');
        const output = document.getElementById('terminal-output');
        
        if (!commandInput || !terminalSessionId) return;

        const command = commandInput.value.trim();
        if (!command) return;
        
        // Send command to terminal (without \r\n since manager adds it)
        try {
            const response = await fetch(`/api/terminal/${terminalSessionId}/write`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ input: command })
            });
            
            const data = await response.json();
            
            if (!data.success) {
                output.textContent += `Error: ${data.error}\r\n`;
            }
        } catch (error) {
            output.textContent += `Error de conexi√≥n: ${error.message}\r\n`;
        }

        // Clear input and scroll to bottom
        commandInput.value = '';
        output.scrollTop = output.scrollHeight;
    }

    async function pollTerminalOutput() {
        if (!terminalSessionId) return;
        
        try {
            const response = await fetch(`/api/terminal/${terminalSessionId}/output`);
            const data = await response.json();
            
            if (data.success && data.output) {
                const output = document.getElementById('terminal-output');
                let chunk = data.output;

                // Strip terminal control sequences (ANSI/OSC) that can show up as "0;user@host"
                // OSC: ESC ] ... BEL or ESC \
                chunk = chunk.replace(/\x1b\][\s\S]*?(?:\x07|\x1b\\)/g, '');
                // CSI: ESC [ ... letter
                chunk = chunk.replace(/\x1b\[[0-9;?]*[ -/]*[@-~]/g, '');
                // Fallback: sometimes title text leaks without the ESC prefix
                chunk = chunk.replace(/(^|\r?\n)0;[^\r\n]*?(?=(\r?\n|$))/g, '$1');

                // Simplify prompt: user@host:/path$ -> user$
                // Also handles root@host:/path# -> root#
                chunk = chunk.replace(/([a-zA-Z0-9_-]+)@[^\s:]+:[^\r\n$#]*([\$#])/g, '$1$2');

                output.textContent += chunk;
                output.scrollTop = output.scrollHeight;
                
                // Update status if session became inactive
                if (!data.active) {
                    document.getElementById('device-status-terminal').textContent = 'Desconectado';
                    clearInterval(terminalInterval);
                    terminalInterval = null;
                }
            }
        } catch (error) {
            console.error('Error polling terminal:', error);
        }
    }

    function closeTerminal() {
        if (terminalInterval) {
            clearInterval(terminalInterval);
            terminalInterval = null;
        }
        
        if (terminalSessionId) {
            // Close terminal session
            fetch(`/api/terminal/${terminalSessionId}/close`, {
                method: 'POST'
            }).catch(console.error);
            terminalSessionId = null;
        }
        
        // Remove modal
        const modal = document.querySelector('div[style*="position: fixed"]');
        if (modal) {
            modal.remove();
        }
    }

    function openRootPrompt() {
        if (!terminalSessionId) return;

        const existing = document.getElementById('root-prompt-modal');
        if (existing) existing.remove();

        const modal = document.createElement('div');
        modal.id = 'root-prompt-modal';
        modal.style.cssText = `
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.75);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1100;
        `;

        modal.innerHTML = `
            <div style="background: var(--ub-dark); border: 2px solid var(--ub-orange); border-radius: 12px; padding: 2rem; max-width: 400px; width: 90%;">
                <h3 style="color: var(--ub-orange); margin: 0 0 1rem 0;">üîê Acceso Root</h3>
                <p style="margin-bottom: 1rem; opacity: 0.9;">Ingresa la contrase√±a de usuario para elevar privilegios a root:</p>
                <input type="password" id="root-password" placeholder="Contrase√±a de usuario" style="width: 100%; background: rgba(255,255,255,0.1); border: 1px solid var(--ub-gray); color: var(--ub-light); padding: 0.75rem; border-radius: 6px; margin-bottom: 1rem; font-family: inherit;">
                <div style="display: flex; gap: 0.5rem;">
                    <button onclick="submitRootAccess()" class="btn-ub" style="flex: 1;">Ejecutar sudo</button>
                    <button onclick="closeRootPrompt()" class="btn-ub" style="background: #666; flex: 1;">Cancelar</button>
                </div>
            </div>
        `;

        document.body.appendChild(modal);
        
        // Focus on password input
        setTimeout(() => {
            document.getElementById('root-password').focus();
        }, 100);
    }

    async function submitRootAccess() {
        const password = document.getElementById('root-password').value;
        if (!password) return;

        try {
            const response = await fetch(`/api/terminal/${terminalSessionId}/write`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ input: `echo '${password}' | sudo -S su` })
            });
            
            const data = await response.json();
            if (data.success) {
                closeRootPrompt();
                // Add visual feedback
                const output = document.getElementById('terminal-output');
                output.textContent += '\r\n[ROOT] Elevando privilegios...\r\n';
            }
        } catch (error) {
            alert('Error al elevar privilegios: ' + error.message);
        }
    }

    function closeRootPrompt() {
        const modal = document.getElementById('root-prompt-modal');
        if (modal) modal.remove();
    }

    // Update Functions
    function checkForUpdates() {
        // Detect OS and choose appropriate script
        const isWindows = navigator.platform.indexOf('Win') !== -1;
        const isMac = navigator.platform.indexOf('Mac') !== -1;
        
        let updateCommand;
        let updateInstructions;
        
        if (isWindows) {
            updateCommand = 'update.bat';
            updateInstructions = `
                <div style="text-align: left; line-height: 1.6;">
                    <h4 style="color: var(--ub-orange); margin-bottom: 1rem;">üîÑ Actualizar UBTool (Windows)</h4>
                    <p><strong>Pasos para actualizar:</strong></p>
                    <ol style="margin-left: 1.5rem;">
                        <li>Cierra esta ventana de UBTool</li>
                        <li>Abre una terminal o s√≠mbolo del sistema</li>
                        <li>Navega al directorio de UBTool</li>
                        <li>Ejecuta: <code style="background: rgba(233,84,32,0.2); padding: 2px 6px; border-radius: 3px;">update.bat</code></li>
                        <li>Sigue las instrucciones del script</li>
                    </ol>
                    <p style="margin-top: 1rem;"><strong>Alternativa:</strong> Descarga manualmente desde <a href="https://github.com/lukasgaleano/UBTool/releases" target="_blank" style="color: var(--ub-orange);">GitHub Releases</a></p>
                </div>
            `;
        } else {
            updateCommand = './update.sh';
            updateInstructions = `
                <div style="text-align: left; line-height: 1.6;">
                    <h4 style="color: var(--ub-orange); margin-bottom: 1rem;">üîÑ Actualizar UBTool (Linux/macOS)</h4>
                    <p><strong>Pasos para actualizar:</strong></p>
                    <ol style="margin-left: 1.5rem;">
                        <li>Cierra esta ventana de UBTool</li>
                        <li>Abre una terminal</li>
                        <li>Navega al directorio de UBTool</li>
                        <li>Ejecuta: <code style="background: rgba(233,84,32,0.2); padding: 2px 6px; border-radius: 3px;">chmod +x update.sh && ./update.sh</code></li>
                        <li>Sigue las instrucciones del script</li>
                    </ol>
                    <p style="margin-top: 1rem;"><strong>Alternativa:</strong> Descarga manualmente desde <a href="https://github.com/lukasgaleano/UBTool/releases" target="_blank" style="color: var(--ub-orange);">GitHub Releases</a></p>
                </div>
            `;
        }
        
        // Create modal
        const modal = document.createElement('div');
        modal.style.cssText = `
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        `;
        
        modal.innerHTML = `
            <div style="background: var(--ub-dark); border: 2px solid var(--ub-orange); border-radius: 12px; padding: 2rem; max-width: 600px; width: 90%; max-height: 80vh; overflow-y: auto;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                    <h3 style="color: var(--ub-orange); margin: 0;">üîÑ Actualizar UBTool</h3>
                    <button onclick="this.closest('div[style*=position]').remove()" style="background: none; border: none; color: var(--ub-light); font-size: 1.5rem; cursor: pointer;">&times;</button>
                </div>
                ${updateInstructions}
            </div>
        `;
        
        document.body.appendChild(modal);
        
        // Close sidebar
        if (isSidebarOpen) {
            toggleSidebar();
        }
    }

    // Sidebar Functions
    let sidebarTimeout;
    let isSidebarOpen = false;

    function toggleSidebar() {
        const sidebar = document.getElementById('sidebar');
        const overlay = document.getElementById('sidebar-overlay');
        const toggleBtn = document.getElementById('sidebar-toggle');
        
        if (isSidebarOpen) {
            sidebar.classList.remove('open');
            overlay.classList.remove('active');
            toggleBtn.classList.remove('active');
            isSidebarOpen = false;
            clearSidebarTimeout();
        } else {
            sidebar.classList.add('open');
            overlay.classList.add('active');
            toggleBtn.classList.add('active');
            isSidebarOpen = true;
            startSidebarTimeout();
        }
    }

    function startSidebarTimeout() {
        clearSidebarTimeout();
        sidebarTimeout = setTimeout(() => {
            if (isSidebarOpen) {
                toggleSidebar();
            }
        }, 5000); // Auto-hide after 5 seconds
    }

    function clearSidebarTimeout() {
        if (sidebarTimeout) {
            clearTimeout(sidebarTimeout);
            sidebarTimeout = null;
        }
    }

    // Reset timeout on mouse movement over sidebar
    document.addEventListener('DOMContentLoaded', () => {
        const sidebar = document.getElementById('sidebar');
        if (sidebar) {
            sidebar.addEventListener('mouseenter', () => {
                if (isSidebarOpen) {
                    clearSidebarTimeout();
                }
            });
            
            sidebar.addEventListener('mouseleave', () => {
                if (isSidebarOpen) {
                    startSidebarTimeout();
                }
            });
        }
    });

    function showDeviceInfo() {
        // Scroll to device info section
        const deviceSection = document.querySelector('.hero-section');
        if (deviceSection) {
            deviceSection.scrollIntoView({ behavior: 'smooth' });
        }
        // Close sidebar after navigation
        if (isSidebarOpen) {
            toggleSidebar();
        }
    }

    function rebootDevice() {
        if (confirm('¬øEst√°s seguro de que quieres reiniciar el dispositivo?')) {
            // Implement reboot functionality
            alert('Reiniciando dispositivo - Esta funci√≥n estar√° disponible pr√≥ximamente');
        }
        // Close sidebar after action
        if (isSidebarOpen) {
            toggleSidebar();
        }
    }

    // Initialize on page load
    window.onload = async function() {
        // Initialize language
        initializeLanguage();
        
        // Check device connection
        checkDevice();
        
        // Check for updates
        checkForUpdatesBackground();
        
        // Initialize sidebar
        initializeSidebar();
    };

    // Background version check
    async function checkForUpdatesBackground() {
        try {
            const response = await fetch('/api/version/check');
            const data = await response.json();
            
            if (data.success) {
                // Update current version display
                const currentVersionElements = document.querySelectorAll('#current-version, #current-version-footer');
                currentVersionElements.forEach(el => {
                    el.textContent = data.current_version;
                });
                
                // Show update notification if available
                if (data.has_update) {
                    const notification = document.getElementById('update-notification');
                    const latestVersionElement = document.getElementById('latest-version');
                    
                    if (notification && latestVersionElement) {
                        latestVersionElement.textContent = data.latest_version;
                        notification.style.display = 'block';
                        
                        console.log(`Nueva versi√≥n disponible: ${data.latest_version} (actual: ${data.current_version})`);
                    }
                }
            } else {
                console.warn('No se pudo verificar la versi√≥n:', data.error);
            }
        } catch (error) {
            console.error('Error verificando actualizaciones:', error);
        }
    }

    function initializeLanguage() {
        const lang = getCurrentLanguage();
        applyTranslations(lang);
        
        const langToggle = document.getElementById('lang-toggle');
        if (langToggle) {
            langToggle.addEventListener('click', toggleLanguage);
        }
    }

    function initializeSidebar() {
        const yearEl = document.getElementById('footer-year');
        if (yearEl) {
            yearEl.textContent = String(new Date().getFullYear());
        }
        
        checkDevice();
    };
    
    // Auto-refresh device status every 30 seconds
    setInterval(checkDevice, 30000);
</script>
{% endblock %}
