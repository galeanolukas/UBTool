{% extends "base.html" %}

{% block title %}Apps Instaladas - UBTool{% endblock %}

{% block content %}
<div class="w3-container" style="padding: 2rem 0;">
    <div class="w3-row-padding">
        <div class="w3-col l12">
            <div class="w3-card w3-round-large" style="background: rgba(49, 45, 42, 0.8); border: 2px solid var(--ub-orange); overflow: hidden;">
                <!-- Header -->
                <div class="w3-container" style="background: linear-gradient(135deg, var(--ub-orange) 0%, #FF6B35 100%); padding: 1.5rem;">
                    <div class="w3-row">
                        <div class="w3-col l8">
                            <h2 class="w3-xxlarge" style="margin: 0; color: white;">
                                üìã Apps Instaladas
                            </h2>
                            <p style="margin: 0.5rem 0 0 0; color: rgba(255,255,255,0.9);">
                                Gestiona tus aplicaciones web desarrolladas con UBTool
                            </p>
                        </div>
                        <div class="w3-col l4 w3-right-align">
                            <button onclick="refreshAppsList()" class="w3-btn w3-round-large" style="background: rgba(255,255,255,0.2); color: white; border: 2px solid white; padding: 0.75rem 1.5rem; font-weight: bold; transition: all 0.3s ease;">
                                üîÑ Actualizar Lista
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Status Section -->
                <div id="apps-status" class="w3-container" style="padding: 2rem;">
                    <div class="w3-center">
                        <div style="font-size: 3rem; margin-bottom: 1rem;">üîÑ</div>
                        <h4 style="color: var(--ub-orange);">Cargando aplicaciones...</h4>
                        <p style="color: var(--ub-gray);">Obteniendo lista de apps instaladas</p>
                    </div>
                </div>

                <!-- Apps List -->
                <div id="apps-list" style="display: none;">
                    <div class="w3-container" style="padding: 1rem 2rem 2rem 2rem;">
                        <div class="w3-row">
                            <div class="w3-col l6">
                                <h5 style="color: var(--ub-light); margin: 0;">
                                    <span id="apps-count">0</span> aplicaciones encontradas
                                </h5>
                            </div>
                            <div class="w3-col l6 w3-right-align">
                                <button onclick="createWebAppModal()" class="w3-btn w3-round-large" style="background: var(--ub-orange); color: white; padding: 0.5rem 1.5rem;">
                                    ‚ûï Crear Nueva App
                                </button>
                            </div>
                        </div>
                    </div>

                    <div id="apps-grid" class="w3-container" style="padding: 0 2rem 2rem 2rem;">
                        <!-- Apps will be loaded here -->
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div id="delete-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 1000;">
    <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: var(--ub-dark); border: 2px solid var(--ub-orange); border-radius: 12px; padding: 2rem; max-width: 400px; width: 90%;">
        <h3 style="color: var(--ub-orange); margin: 0 0 1rem 0;">‚ö†Ô∏è Confirmar Eliminaci√≥n</h3>
        <p style="color: var(--ub-light); margin-bottom: 1.5rem;">
            ¬øEst√°s seguro de que quieres eliminar la aplicaci√≥n "<span id="delete-app-name"></span>"? Esta acci√≥n no se puede deshacer.
        </p>
        <div style="display: flex; gap: 1rem;">
            <button onclick="confirmDelete()" class="w3-btn w3-round-large" style="background: #f44336; color: white; flex: 1;">
                üóëÔ∏è Eliminar
            </button>
            <button onclick="closeDeleteModal()" class="w3-btn w3-round-large" style="background: rgba(255,255,255,0.1); color: var(--ub-light); border: 1px solid var(--ub-orange); flex: 1;">
                Cancelar
            </button>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let appToDelete = null;

// Load apps on page load
document.addEventListener('DOMContentLoaded', function() {
    refreshAppsList();
});

async function refreshAppsList() {
    const statusDiv = document.getElementById('apps-status');
    const appsList = document.getElementById('apps-list');
    const appsGrid = document.getElementById('apps-grid');
    const appsCount = document.getElementById('apps-count');
    
    try {
        const response = await fetch('/api/devtools/list_apps');
        const data = await response.json();
        
        if (data.success) {
            statusDiv.style.display = 'none';
            appsList.style.display = 'block';
            
            appsCount.textContent = data.apps.length;
            
            if (data.apps.length === 0) {
                appsGrid.innerHTML = `
                    <div class="w3-center" style="padding: 3rem;">
                        <div style="font-size: 4rem; margin-bottom: 1rem;">üì±</div>
                        <h4 style="color: var(--ub-orange); margin-bottom: 1rem;">No hay aplicaciones instaladas</h4>
                        <p style="color: var(--ub-gray); margin-bottom: 2rem;">
                            Crea tu primera WebApp usando el bot√≥n "Crear Nueva App".
                        </p>
                        <button onclick="createWebAppModal()" class="w3-btn w3-round-large" style="background: var(--ub-orange); color: white; padding: 1rem 2rem; font-size: 1.1rem;">
                            ‚ûï Crear Mi Primera App
                        </button>
                    </div>
                `;
            } else {
                appsGrid.innerHTML = data.apps.map(app => `
                    <div class="w3-third" style="padding: 0.5rem;">
                        <div class="w3-card w3-round-large" style="background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); overflow: hidden;">
                            <!-- App Header -->
                            <div style="background: linear-gradient(135deg, rgba(233,84,32,0.2) 0%, rgba(255,107,53,0.1) 100%); padding: 1rem;">
                                <div class="w3-row">
                                    <div class="w3-col l8">
                                        <h4 style="color: var(--ub-orange); margin: 0; font-size: 1.2rem;">üöÄ ${app.name}</h4>
                                        <div style="margin-top: 0.5rem;">
                                            ${app.has_venv ? '<span class="w3-tag w3-round" style="background: #4CAF50; color: white;">‚úÖ Entorno</span>' : '<span class="w3-tag w3-round" style="background: #f44336; color: white;">‚ùå Sin Entorno</span>'}
                                            ${app.is_running ? '<span class="w3-tag w3-round" style="background: #2196F3; color: white; margin-left: 0.25rem;">‚ñ∂Ô∏è Activa</span>' : '<span class="w3-tag w3-round" style="background: #9E9E9E; color: white; margin-left: 0.25rem;">‚è∏Ô∏è Inactiva</span>'}
                                        </div>
                                    </div>
                                    <div class="w3-col l4 w3-right-align">
                                        <div style="font-size: 2rem;">${getFrameworkIcon(app.config.framework || 'unknown')}</div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- App Info -->
                            <div style="padding: 1rem;">
                                <p style="margin: 0; font-size: 0.9rem; color: var(--ub-gray);">
                                    <strong>Ruta:</strong> <code style="background: rgba(255,255,255,0.1); padding: 2px 6px; border-radius: 4px;">${app.path}</code>
                                </p>
                                ${app.config.framework ? `
                                    <p style="margin: 0.5rem 0 0 0; font-size: 0.9rem; color: var(--ub-gray);">
                                        <strong>Framework:</strong> ${app.config.framework}
                                    </p>
                                ` : ''}
                                ${app.config.port ? `
                                    <p style="margin: 0.5rem 0 0 0; font-size: 0.9rem; color: var(--ub-gray);">
                                        <strong>Puerto:</strong> ${app.config.port}
                                    </p>
                                ` : ''}
                            </div>
                            
                            <!-- Action Buttons -->
                            <div style="padding: 0 1rem 1rem 1rem;">
                                <div class="w3-row">
                                    <div class="w3-col s6" style="padding: 0.25rem;">
                                        <button onclick="startApp('${app.name}')" class="w3-btn w3-round-large w3-block" style="background: #4CAF50; color: white; padding: 0.5rem;">
                                            ‚ñ∂Ô∏è Iniciar
                                        </button>
                                    </div>
                                    <div class="w3-col s6" style="padding: 0.25rem;">
                                        <button onclick="stopApp('${app.name}')" class="w3-btn w3-round-large w3-block" style="background: #f44336; color: white; padding: 0.5rem;">
                                            ‚èπÔ∏è Detener
                                        </button>
                                    </div>
                                </div>
                                <div class="w3-row" style="margin-top: 0.5rem;">
                                    <div class="w3-col s6" style="padding: 0.25rem;">
                                        <button onclick="openApp('${app.name}', ${app.config.port || 8081})" class="w3-btn w3-round-large w3-block" style="background: var(--ub-orange); color: white; padding: 0.5rem;">
                                            üåê Abrir
                                        </button>
                                    </div>
                                    <div class="w3-col s6" style="padding: 0.25rem;">
                                        <button onclick="showDeleteModal('${app.name}')" class="w3-btn w3-round-large w3-block" style="background: rgba(244,67,54,0.2); color: #f44336; border: 1px solid #f44336; padding: 0.5rem;">
                                            üóëÔ∏è Eliminar
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `).join('');
            }
        } else {
            statusDiv.innerHTML = `
                <div class="w3-center">
                    <div style="font-size: 3rem; margin-bottom: 1rem;">‚ùå</div>
                    <h4 style="color: #f44336;">Error cargando aplicaciones</h4>
                    <p style="color: var(--ub-gray);">${data.error}</p>
                </div>
            `;
        }
    } catch (error) {
        statusDiv.innerHTML = `
            <div class="w3-center">
                <div style="font-size: 3rem; margin-bottom: 1rem;">üîå</div>
                <h4 style="color: #f44336;">Error de conexi√≥n</h4>
                <p style="color: var(--ub-gray);">${error.message}</p>
            </div>
        `;
    }
}

function getFrameworkIcon(framework) {
    const icons = {
        'microdot': 'üöÄ',
        'flask': 'üå∂Ô∏è',
        'fastapi': '‚ö°',
        'django': 'üé∏',
        'bottle': 'üçæ',
        'http-server': 'üìÅ',
        'nodejs': 'üü¢',
        'react': '‚öõÔ∏è',
        'vue': 'üíö'
    };
    return icons[framework] || 'üì±';
}

async function startApp(appName) {
    try {
        const response = await fetch('/api/devtools/start_app', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ app_name: appName })
        });
        
        const data = await response.json();
        
        if (data.success) {
            showNotification(`‚úÖ ${data.message}`, 'success');
            if (data.access_url) {
                showNotification(`üåê URL: ${data.access_url}`, 'info');
            }
            refreshAppsList();
        } else {
            showNotification(`‚ùå Error: ${data.error}`, 'error');
        }
    } catch (error) {
        showNotification(`‚ùå Error de conexi√≥n: ${error.message}`, 'error');
    }
}

async function stopApp(appName) {
    try {
        const response = await fetch('/api/devtools/stop_app', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ app_name: appName })
        });
        
        const data = await response.json();
        
        if (data.success) {
            showNotification(`‚úÖ ${data.message}`, 'success');
            refreshAppsList();
        } else {
            showNotification(`‚ùå Error: ${data.error}`, 'error');
        }
    } catch (error) {
        showNotification(`‚ùå Error de conexi√≥n: ${error.message}`, 'error');
    }
}

function openApp(appName, port) {
    const url = `http://localhost:${port}`;
    window.open(url, '_blank');
    showNotification(`üåê Abriendo ${appName} en ${url}`, 'info');
}

function showDeleteModal(appName) {
    appToDelete = appName;
    document.getElementById('delete-app-name').textContent = appName;
    document.getElementById('delete-modal').style.display = 'block';
}

function closeDeleteModal() {
    document.getElementById('delete-modal').style.display = 'none';
    appToDelete = null;
}

async function confirmDelete() {
    if (!appToDelete) return;
    
    try {
        const response = await fetch('/api/devtools/delete_app', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ app_name: appToDelete })
        });
        
        const data = await response.json();
        
        if (data.success) {
            showNotification(`‚úÖ ${data.message}`, 'success');
            closeDeleteModal();
            refreshAppsList();
        } else {
            showNotification(`‚ùå Error: ${data.error}`, 'error');
        }
    } catch (error) {
        showNotification(`‚ùå Error de conexi√≥n: ${error.message}`, 'error');
    }
}

function showNotification(message, type) {
    // Create notification element
    const notification = document.createElement('div');
    notification.className = 'w3-card w3-round-large';
    notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 1rem 1.5rem;
        z-index: 2000;
        min-width: 300px;
        animation: slideIn 0.3s ease;
    `;
    
    // Set color based on type
    const colors = {
        success: { bg: '#4CAF50', text: 'white' },
        error: { bg: '#f44336', text: 'white' },
        info: { bg: '#2196F3', text: 'white' }
    };
    
    const color = colors[type] || colors.info;
    notification.style.background = color.bg;
    notification.style.color = color.text;
    
    notification.innerHTML = message;
    document.body.appendChild(notification);
    
    // Auto remove after 3 seconds
    setTimeout(() => {
        notification.style.animation = 'slideOut 0.3s ease';
        setTimeout(() => notification.remove(), 300);
    }, 3000);
}

// Add animations
const style = document.createElement('style');
style.textContent = `
    @keyframes slideIn {
        from { transform: translateX(100%); opacity: 0; }
        to { transform: translateX(0); opacity: 1; }
    }
    @keyframes slideOut {
        from { transform: translateX(0); opacity: 1; }
        to { transform: translateX(100%); opacity: 0; }
    }
`;
document.head.appendChild(style);
</script>
{% endblock %}
