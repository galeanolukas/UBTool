{% extends "base.html" %}

{% block title %}Apps Instaladas - UBTool{% endblock %}

{% block content %}
<div class="w3-container" style="padding: 2rem 0;">
    <div class="w3-row-padding">
        <div class="w3-col l12">
            <div class="w3-card w3-round-large" style="background: rgba(49, 45, 42, 0.8); border: 2px solid var(--ub-orange); overflow: hidden;">
                <!-- Header -->
                <div class="w3-container" style="background: linear-gradient(135deg, var(--ub-orange) 0%, #FF6B35 100%); padding: 1.5rem;">
                    <div class="w3-row">
                        <div class="w3-col l8">
                            <h2 class="w3-xxlarge" style="margin: 0; color: white;">
                                üìã Apps Instaladas
                            </h2>
                            <p style="margin: 0.5rem 0 0 0; color: rgba(255,255,255,0.9);">
                                Gestiona tus aplicaciones web desarrolladas con UBTool
                            </p>
                        </div>
                        <div class="w3-col l4 w3-right-align">
                            <button onclick="refreshAppsList()" class="w3-btn w3-round-large" style="background: rgba(255,255,255,0.2); color: white; border: 2px solid white; padding: 0.75rem 1.5rem; font-weight: bold; transition: all 0.3s ease;">
                                üîÑ Actualizar Lista
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Status Section -->
                <div id="apps-status" class="w3-container" style="padding: 2rem;">
                    <div class="w3-center">
                        <div style="font-size: 3rem; margin-bottom: 1rem;">üîÑ</div>
                        <h4 style="color: var(--ub-orange);">Cargando aplicaciones...</h4>
                        <p style="color: var(--ub-gray);">Obteniendo lista de apps instaladas</p>
                    </div>
                </div>

                <!-- Apps List -->
                <div id="apps-list" style="display: none;">
                    <div class="w3-container" style="padding: 1rem 2rem 2rem 2rem;">
                        <div class="w3-row">
                            <div class="w3-col l6">
                                <h5 style="color: var(--ub-light); margin: 0;">
                                    <span id="apps-count">0</span> aplicaciones encontradas
                                </h5>
                            </div>
                            <div class="w3-col l6 w3-right-align">
                                <button onclick="createWebAppModal()" class="w3-btn w3-round-large" style="background: var(--ub-orange); color: white; padding: 0.5rem 1.5rem;">
                                    ‚ûï Crear Nueva App
                                </button>
                            </div>
                        </div>
                    </div>

                    <div id="apps-grid" class="w3-container" style="padding: 0 2rem 2rem 2rem;">
                        <!-- Apps will be loaded here -->
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div id="delete-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 1000;">
    <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: var(--ub-dark); border: 2px solid var(--ub-orange); border-radius: 12px; padding: 2rem; max-width: 400px; width: 90%;">
        <h3 style="color: var(--ub-orange); margin: 0 0 1rem 0;">‚ö†Ô∏è Confirmar Eliminaci√≥n</h3>
        <p style="color: var(--ub-light); margin-bottom: 1.5rem;">
            ¬øEst√°s seguro de que quieres eliminar la aplicaci√≥n "<span id="delete-app-name"></span>"? Esta acci√≥n no se puede deshacer.
        </p>
        <div style="display: flex; gap: 1rem;">
            <button onclick="confirmDelete()" class="w3-btn w3-round-large" style="background: #f44336; color: white; flex: 1;">
                üóëÔ∏è Eliminar
            </button>
            <button onclick="closeDeleteModal()" class="w3-btn w3-round-large" style="background: rgba(255,255,255,0.1); color: var(--ub-light); border: 1px solid var(--ub-orange); flex: 1;">
                Cancelar
            </button>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Helper function to safely parse JSON responses
async function parseJSONResponse(response) {
    if (!response.ok) {
        if (response.status === 413) {
            throw new Error('El archivo es demasiado grande. El tama√±o m√°ximo permitido es 100MB.');
        }
        throw new Error(`HTTP error! status: ${response.status}`);
    }
    
    const text = await response.text();
    if (!text) {
        throw new Error('Empty response from server');
    }
    
    try {
        return JSON.parse(text);
    } catch (jsonError) {
        console.error('JSON parse error:', jsonError, 'Response text:', text);
        throw new Error(`Invalid JSON response: ${jsonError.message}`);
    }
}

let appToDelete = null;

// Load apps on page load
document.addEventListener('DOMContentLoaded', function() {
    refreshAppsList();
});

async function refreshAppsList() {
    const statusDiv = document.getElementById('apps-status');
    const appsList = document.getElementById('apps-list');
    const appsGrid = document.getElementById('apps-grid');
    const appsCount = document.getElementById('apps-count');
    
    try {
        const response = await fetch('/api/devtools/list_apps');
        const data = await parseJSONResponse(response);
        
        if (data.success) {
            statusDiv.style.display = 'none';
            appsList.style.display = 'block';
            
            appsCount.textContent = data.apps.length;
            
            if (data.apps.length === 0) {
                appsGrid.innerHTML = `
                    <div class="w3-center" style="padding: 3rem;">
                        <div style="font-size: 4rem; margin-bottom: 1rem;">üì±</div>
                        <h4 style="color: var(--ub-orange); margin-bottom: 1rem;">No hay aplicaciones instaladas</h4>
                        <p style="color: var(--ub-gray); margin-bottom: 2rem;">
                            Crea tu primera WebApp usando el bot√≥n "Crear Nueva App".
                        </p>
                        <button onclick="createWebAppModal()" class="w3-btn w3-round-large" style="background: var(--ub-orange); color: white; padding: 1rem 2rem; font-size: 1.1rem;">
                            ‚ûï Crear Mi Primera App
                        </button>
                    </div>
                `;
            } else {
                appsGrid.innerHTML = data.apps.map(app => `
                    <div class="w3-third" style="padding: 0.5rem;">
                        <div class="w3-card w3-round-large" style="background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); overflow: hidden; transition: all 0.3s ease;" 
                             onmouseover="this.style.transform='translateY(-5px)'; this.style.boxShadow='0 10px 30px rgba(233,84,32,0.2)'; this.style.borderColor='var(--ub-orange)'" 
                             onmouseout="this.style.transform=''; this.style.boxShadow=''; this.style.borderColor='rgba(255,255,255,0.1)'">
                            <!-- App Header -->
                            <div style="background: linear-gradient(135deg, rgba(233,84,32,0.2) 0%, rgba(255,107,53,0.1) 100%); padding: 1rem;">
                                <div class="w3-row">
                                    <div class="w3-col l8">
                                        <h4 style="color: var(--ub-orange); margin: 0; font-size: 1.2rem; font-weight: 600;">üöÄ ${app.name}</h4>
                                        <div style="margin-top: 0.5rem; display: flex; flex-wrap: wrap; gap: 0.25rem;">
                                            ${app.has_venv ? '<span class="w3-tag w3-round" style="background: #4CAF50; color: white; font-size: 0.75rem; padding: 2px 6px;">‚úÖ Entorno</span>' : '<span class="w3-tag w3-round" style="background: #f44336; color: white; font-size: 0.75rem; padding: 2px 6px;">‚ùå Sin Entorno</span>'}
                                            ${app.is_running ? '<span class="w3-tag w3-round" style="background: #2196F3; color: white; font-size: 0.75rem; padding: 2px 6px;">‚ñ∂Ô∏è Activa</span>' : '<span class="w3-tag w3-round" style="background: #9E9E9E; color: white; font-size: 0.75rem; padding: 2px 6px;">‚è∏Ô∏è Inactiva</span>'}
                                            ${app.process_info && app.process_info.START_TIME ? `<span class="w3-tag w3-round" style="background: #FF9800; color: white; font-size: 0.75rem; padding: 2px 6px;">üïê ${app.process_info.START_TIME}</span>` : ''}
                                        </div>
                                    </div>
                                    <div class="w3-col l4 w3-right-align">
                                        <div style="font-size: 2rem; opacity: 0.8;">${getFrameworkIcon(app.config.framework || 'unknown')}</div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- App Info -->
                            <div style="padding: 1rem;">
                                <div style="background: rgba(255,255,255,0.03); padding: 0.75rem; border-radius: 8px; margin-bottom: 0.75rem;">
                                    <p style="margin: 0; font-size: 0.85rem; color: var(--ub-gray); display: flex; align-items: center; gap: 0.5rem;">
                                        <strong style="color: var(--ub-orange);">üìÅ Ruta:</strong> 
                                        <code style="background: rgba(255,255,255,0.1); padding: 2px 6px; border-radius: 4px; font-size: 0.8rem; flex: 1; word-break: break-all;">${app.path}</code>
                                    </p>
                                </div>
                                
                                ${app.config.framework ? `
                                    <div style="background: rgba(255,255,255,0.03); padding: 0.75rem; border-radius: 8px; margin-bottom: 0.75rem;">
                                        <p style="margin: 0; font-size: 0.85rem; color: var(--ub-gray); display: flex; align-items: center; gap: 0.5rem;">
                                            <strong style="color: var(--ub-orange);">‚öôÔ∏è Framework:</strong> 
                                            <span style="background: rgba(233,84,32,0.2); padding: 2px 8px; border-radius: 4px; font-size: 0.8rem;">${app.config.framework}</span>
                                        </p>
                                    </div>
                                ` : ''}
                                
                                ${app.config.port ? `
                                    <div style="background: rgba(255,255,255,0.03); padding: 0.75rem; border-radius: 8px; margin-bottom: 0.75rem;">
                                        <p style="margin: 0; font-size: 0.85rem; color: var(--ub-gray); display: flex; align-items: center; gap: 0.5rem;">
                                            <strong style="color: var(--ub-orange);">üåê Puerto:</strong> 
                                            <span style="background: ${app.is_running ? '#4CAF50' : '#9E9E9E'}; color: white; padding: 2px 8px; border-radius: 4px; font-size: 0.8rem; font-weight: 600;">${app.config.port}</span>
                                            ${app.is_running ? `<a href="http://localhost:${app.config.port}" target="_blank" style="margin-left: 0.5rem; color: var(--ub-orange); text-decoration: none; font-size: 0.8rem;">üîó Abrir</a>` : ''}
                                        </p>
                                    </div>
                                ` : ''}
                            </div>
                            
                            <!-- Action Buttons -->
                            <div style="padding: 0 1rem 1rem 1rem; border-top: 1px solid rgba(255,255,255,0.1);">
                                <div class="w3-row" style="margin-top: 0.5rem;">
                                    <div class="w3-col s12" style="padding: 0.25rem;">
                                        <button onclick="toggleApp('${app.name}')" class="w3-btn w3-round-large w3-block" 
                                                style="background: ${app.is_running ? '#f44336' : '#4CAF50'}; color: white; padding: 0.6rem; font-size: 1rem; transition: all 0.3s ease; font-weight: 500;">
                                            ${app.is_running ? '‚èπÔ∏è Detener' : '‚ñ∂Ô∏è Iniciar'}
                                        </button>
                                    </div>
                                </div>
                                <div class="w3-row" style="margin-top: 0.5rem;">
                                    <div class="w3-col s4" style="padding: 0.25rem;">
                                        <button onclick="viewLogs('${app.name}')" class="w3-btn w3-round-large w3-block" 
                                                style="background: #FF9800; color: white; padding: 0.5rem; font-size: 0.9rem;">
                                            üìã Ver Logs
                                        </button>
                                    </div>
                                    <div class="w3-col s4" style="padding: 0.25rem;">
                                        ${app.is_in_develop_mode ? 
                                            `<button onclick="stopDevelopMode('${app.name}')" class="w3-btn w3-round-large w3-block" 
                                                    style="background: #f44336; color: white; padding: 0.5rem; font-size: 0.9rem; position: relative;">
                                                üõë Detener T√∫nel
                                                <span style="position: absolute; top: 5px; right: 5px; width: 8px; height: 8px; background: #f44336; border-radius: 50%; animation: pulse 2s infinite;"></span>
                                            </button>` :
                                            `<button onclick="modoDesarrollo('${app.name}')" class="w3-btn w3-round-large w3-block" 
                                                    style="background: ${app.is_running ? '#2196F3' : '#9E9E9E'}; color: white; padding: 0.5rem; font-size: 0.9rem; ${!app.is_running ? 'cursor: not-allowed; opacity: 0.6;' : ''}" 
                                                    ${!app.is_running ? 'disabled' : ''}>
                                                ${app.is_running ? 'üõ†Ô∏è Modo Desarrollo' : 'üõ†Ô∏è Modo Desarrollo'}
                                            </button>`
                                        }
                                    </div>
                                    <div class="w3-col s4" style="padding: 0.25rem;">
                                        <button onclick="showDeleteModal('${app.name}')" class="w3-btn w3-round-large w3-block" 
                                                style="background: rgba(244,67,54,0.2); color: #f44336; border: 1px solid #f44336; padding: 0.5rem;">
                                            üóëÔ∏è Eliminar
                                        </button>
                                    </div>
                                </div>
                                ${app.process_info && app.process_info.PID ? `
                                    <div style="margin-top: 0.5rem; padding: 0.5rem; background: rgba(255,255,255,0.05); border-radius: 4px; font-size: 0.8rem; color: var(--ub-gray);">
                                        <strong>PID:</strong> ${app.process_info.PID} | 
                                        <strong>Puerto:</strong> ${app.process_info.PORT || app.config.port || 'N/A'} |
                                        <strong>Estado:</strong> ${app.process_info.STATUS || 'unknown'}
                                        ${app.is_in_develop_mode && app.tunnel_info.LOCAL_PORT ? 
                                            `| <strong>T√∫nel:</strong> <a href="http://localhost:${app.tunnel_info.LOCAL_PORT}" target="_blank" style="color: var(--ub-orange); text-decoration: none;">localhost:${app.tunnel_info.LOCAL_PORT}</a>` : 
                                            ''
                                        }
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                `).join('');
            }
        } else {
            statusDiv.innerHTML = `
                <div class="w3-center">
                    <div style="font-size: 3rem; margin-bottom: 1rem;">‚ùå</div>
                    <h4 style="color: #f44336;">Error cargando aplicaciones</h4>
                    <p style="color: var(--ub-gray);">${data.error}</p>
                </div>
            `;
        }
    } catch (error) {
        statusDiv.innerHTML = `
            <div class="w3-center">
                <div style="font-size: 3rem; margin-bottom: 1rem;">üîå</div>
                <h4 style="color: #f44336;">Error de conexi√≥n</h4>
                <p style="color: var(--ub-gray);">${error.message}</p>
            </div>
        `;
    }
}

function getFrameworkIcon(framework) {
    const icons = {
        'microdot': 'üöÄ',
        'flask': 'üå∂Ô∏è',
        'fastapi': '‚ö°',
        'django': 'üé∏',
        'bottle': 'üçæ',
        'http-server': 'üìÅ',
        'nodejs': 'üü¢',
        'react': '‚öõÔ∏è',
        'vue': 'üíö'
    };
    return icons[framework] || 'üì±';
}

async function modoDesarrollo(appName) {
    try {
        showNotification(`üõ†Ô∏è Iniciando modo develop para ${appName}...`, 'info');
        
        const response = await fetch('/api/simple-develop/start', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ 
                app_name: appName
            })
        });
        
        const data = await parseJSONResponse(response);
        
        if (data.success) {
            let message = `‚úÖ ${data.data.message}`;
            
            if (data.data.local_url) {
                message += `\n\nüåê Acceso local: ${data.data.local_url}`;
                message += `\nüîó T√∫nel: localhost:${data.data.local_port} ‚Üí dispositivo:${data.data.device_port}`;
                
                // Abrir URL local autom√°ticamente
                setTimeout(() => {
                    window.open(data.data.local_url, '_blank');
                }, 1000);
            }
            
            if (data.data.workspace) {
                message += `\n\nüìÅ Workspace local: ${data.data.workspace.local_path}`;
                message += `\nüí° Abre esta carpeta en tu IDE preferido`;
                
                if (data.data.sync_script) {
                    message += `\nüîÑ Script de sincronizaci√≥n: ${data.data.sync_script}`;
                    message += `\n   Ejecuta: bash ${data.data.sync_script}`;
                }
                
                // Guardar informaci√≥n del workspace para referencia
                localStorage.setItem(`ubtool_workspace_${data.data.app_name}`, JSON.stringify(data.data.workspace));
                localStorage.setItem(`ubtool_sync_script_${data.data.app_name}`, data.data.sync_script);
                
                // Mostrar instrucciones
                setTimeout(() => {
                    const isWindows = navigator.platform.indexOf('Win') !== -1;
                    const syncCommand = isWindows ? 
                        `sync.bat` : 
                        `bash ${data.data.sync_script}`;
                    
                    alert(`üìã Instrucciones de desarrollo:\n\n` +
                          `1. Abre la carpeta del workspace en tu IDE:\n   ${data.data.workspace.local_path}\n\n` +
                          `2. Edita los archivos que necesites\n\n` +
                          `3. Para sincronizar cambios autom√°ticamente:\n   ${syncCommand}\n\n` +
                          `4. O sincroniza manualmente con:\n   adb push "${data.data.workspace.local_path}/" "${data.data.workspace.device_path}/"\n\n` +
                          `5. Tu app est√° disponible en: ${data.data.local_url}`);
                }, 1500);
            }
            
            showNotification(message, 'success', 12000);
            
            // Actualizar lista de apps para mostrar estado
            setTimeout(() => {
                refreshAppsList();
            }, 2000);
            
        } else {
            if (data.error && data.error.includes('no est√° corriendo')) {
                showNotification(`‚ö†Ô∏è ${data.error}`, 'warning', 6000);
                showNotification(`üí° Por favor, inicia la app "${appName}" primero con el bot√≥n "‚ñ∂Ô∏è Iniciar"`, 'info', 8000);
            } else {
                showNotification(`‚ùå Error al iniciar modo develop: ${data.error}`, 'error', 6000);
            }
        }
    } catch (error) {
        showNotification(`‚ùå Error de conexi√≥n: ${error.message}`, 'error', 6000);
    }
}

async function stopDevelopMode(appName) {
    try {
        showNotification(`üõë Deteniendo modo develop para ${appName}...`, 'info');
        
        const response = await fetch(`/api/simple-develop/stop/${encodeURIComponent(appName)}`, {
            method: 'POST'
        });
        
        const data = await parseJSONResponse(response);
        
        if (data.success) {
            showNotification(data.message, 'success', 5000);
            
            // Actualizar lista de apps
            setTimeout(() => {
                refreshAppsList();
            }, 1500);
            
        } else {
            showNotification(`‚ùå Error al detener t√∫nel: ${data.error}`, 'error', 6000);
        }
    } catch (error) {
        showNotification(`‚ùå Error de conexi√≥n: ${error.message}`, 'error', 6000);
    }
}

async function toggleApp(appName) {
    try {
        // Mostrar indicador de carga
        const button = document.querySelector(`button[onclick="toggleApp('${appName}')"]`);
        if (button) {
            button.disabled = true;
            button.innerHTML = '‚è≥ Procesando...';
            button.style.opacity = '0.6';
        }
        
        // Obtener estado actual de la app
        const appsResponse = await fetch('/api/devtools/list_apps');
        const appsData = await parseJSONResponse(appsResponse);
        
        if (appsData.success && appsData.apps) {
            const currentApp = appsData.apps.find(app => app.name === appName);
            
            if (currentApp && currentApp.is_running) {
                // App est√° corriendo, la detenemos
                console.log(`üõë Stopping app: ${appName}`);
                await stopApp(appName);
            } else {
                // App no est√° corriendo, la iniciamos
                console.log(`‚ñ∂Ô∏è Starting app: ${appName}`);
                await startApp(appName);
            }
            
            // Esperar un momento y refrescar para actualizar el estado
            setTimeout(() => {
                refreshAppsList();
            }, 2000);
            
        } else {
            showNotification('‚ùå No se pudo obtener el estado de las apps', 'error');
        }
    } catch (error) {
        showNotification(`‚ùå Error en toggle: ${error.message}`, 'error');
        // Restaurar bot√≥n en caso de error
        const button = document.querySelector(`button[onclick="toggleApp('${appName}')"]`);
        if (button) {
            button.disabled = false;
            button.style.opacity = '1';
        }
    }
}

async function startApp(appName) {
    try {
        const response = await fetch('/api/devtools/start_app', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ app_name: appName })
        });
        
        const data = await parseJSONResponse(response);
        
        if (data.success) {
            showNotification(`‚úÖ ${data.message}`, 'success');
            if (data.access_url) {
                showNotification(`üåê URL: ${data.access_url}`, 'info');
            }
            // Esperar a que la app inicie completamente antes de refrescar
            setTimeout(() => {
                refreshAppsList();
            }, 1500);
        } else {
            showNotification(`‚ùå Error: ${data.error}`, 'error');
        }
    } catch (error) {
        showNotification(`‚ùå Error de conexi√≥n: ${error.message}`, 'error');
    }
}

async function stopApp(appName) {
    try {
        showNotification(`üõë Deteniendo app ${appName}...`, 'info');
        
        // Verificar si est√° en modo desarrollo y detener t√∫nel
        try {
            const developResponse = await fetch(`/api/simple-develop/status`, {
                method: 'GET'
            });
            
            const developData = await parseJSONResponse(developResponse);
            
            if (developData.success && developData.active_tunnels) {
                const tunnelForApp = developData.active_tunnels.find(tunnel => tunnel.app_name === appName);
                
                if (tunnelForApp) {
                    showNotification(`üîÑ Deteniendo modo desarrollo para ${appName}...`, 'info');
                    
                    // Detener t√∫nel espec√≠fico de la app
                    const stopDevelopResponse = await fetch(`/api/simple-develop/stop/${encodeURIComponent(appName)}`, {
                        method: 'POST'
                    });
                    
                    const stopDevelopData = await parseJSONResponse(stopDevelopResponse);
                    if (stopDevelopData.success) {
                        showNotification(`‚úÖ ${stopDevelopData.message}`, 'success', 3000);
                    } else {
                        showNotification(`‚ö†Ô∏è ${stopDevelopData.error}`, 'warning', 3000);
                    }
                }
            }
        } catch (developError) {
            console.log('No se pudo verificar modo desarrollo:', developError);
        }
        
        // Ahora detener la app
        const response = await fetch('/api/devtools/stop_app', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ app_name: appName })
        });
        
        const data = await parseJSONResponse(response);
        
        if (data.success) {
            showNotification(`‚úÖ ${data.message}`, 'success');
            // Esperar a que la app se detenga completamente antes de refrescar
            setTimeout(() => {
                refreshAppsList();
            }, 1500);
        } else {
            showNotification(`‚ùå Error: ${data.error}`, 'error');
        }
    } catch (error) {
        showNotification(`‚ùå Error de conexi√≥n: ${error.message}`, 'error');
    }
}

function openApp(appName, port) {
    const url = `http://localhost:${port}`;
    window.open(url, '_blank');
    showNotification(`üåê Abriendo ${appName} en ${url}`, 'info');
}

function showDeleteModal(appName) {
    appToDelete = appName;
    document.getElementById('delete-app-name').textContent = appName;
    document.getElementById('delete-modal').style.display = 'block';
}

function closeDeleteModal() {
    document.getElementById('delete-modal').style.display = 'none';
    appToDelete = null;
}

async function confirmDelete() {
    if (!appToDelete) return;
    
    try {
        const response = await fetch('/api/devtools/delete_app', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ app_name: appToDelete })
        });
        
        const data = await parseJSONResponse(response);
        
        if (data.success) {
            showNotification(`‚úÖ ${data.message}`, 'success');
            closeDeleteModal();
            refreshAppsList();
        } else {
            showNotification(`‚ùå Error: ${data.error}`, 'error');
        }
    } catch (error) {
        showNotification(`‚ùå Error de conexi√≥n: ${error.message}`, 'error');
    }
}

function showNotification(message, type, duration = 3000) {
    // Create notification element
    const notification = document.createElement('div');
    notification.className = 'w3-card w3-round-large';
    notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 1rem 1.5rem;
        z-index: 2000;
        min-width: 300px;
        animation: slideIn 0.3s ease-out;
    `;
    
    // Set color based on type
    const colors = {
        success: { bg: '#4CAF50', text: 'white' },
        error: { bg: '#f44336', text: 'white' },
        info: { bg: '#2196F3', text: 'white' }
    };
    
    const color = colors[type] || colors.info;
    notification.style.background = color.bg;
    notification.style.color = color.text;
    
    notification.innerHTML = message;
    document.body.appendChild(notification);
    
    // Auto remove after 3 seconds
    setTimeout(() => {
        notification.style.animation = 'slideOut 0.3s ease';
        setTimeout(() => notification.remove(), 300);
    }, 3000);
}

async function viewLogs(appName) {
    try {
        showNotification(`üìã Cargando logs de ${appName}...`, 'info');
        
        const response = await fetch(`/api/devtools/get_logs?app_name=${encodeURIComponent(appName)}`);
        const data = await parseJSONResponse(response);
        
        if (data.success && data.logs) {
            // Create modal for logs
            const modal = document.createElement('div');
            modal.id = 'logs-viewer-modal';
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.8);
                z-index: 3000;
                display: flex;
                align-items: center;
                justify-content: center;
                backdrop-filter: blur(5px);
            `;
            
            modal.innerHTML = `
                <div style="background: #1a1a1a; border-radius: 15px; padding: 0; max-width: 90vw; max-height: 90vh; width: 900px; height: 600px; display: flex; flex-direction: column; box-shadow: 0 10px 30px rgba(0,0,0,0.5); border: 1px solid rgba(255,255,255,0.1);">
                    <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 1.5rem; border-radius: 15px 15px 0 0; display: flex; justify-content: space-between; align-items: center;">
                        <h3 style="margin: 0; font-size: 1.5rem; font-weight: 600;">
                            üìã Logs de ${appName}
                        </h3>
                        <button onclick="this.closest('#logs-viewer-modal').remove()" style="background: rgba(255,255,255,0.2); border: none; color: white; padding: 0.5rem 1rem; border-radius: 8px; cursor: pointer; font-size: 1.2rem;">
                            ‚úï
                        </button>
                    </div>
                    <div style="padding: 1.5rem; flex: 1; overflow: hidden; display: flex; flex-direction: column;">
                        <div style="background: rgba(255,255,255,0.05); border-radius: 8px; padding: 1rem; margin-bottom: 1rem; border-left: 4px solid #FF9800;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                                <span style="color: #FF9800; font-weight: bold;">üìÅ Archivo:</span>
                                <span style="color: #4CAF50; font-family: monospace; background: rgba(76,175,80,0.2); padding: 0.25rem 0.5rem; border-radius: 4px;">${data.log_file || 'app.log'}</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <span style="color: #FF9800; font-weight: bold;">üìä Tama√±o:</span>
                                <span style="color: #2196F3; font-family: monospace;">${data.file_size || 'N/A'}</span>
                            </div>
                        </div>
                        <div style="background: #000; border-radius: 8px; padding: 1rem; flex: 1; overflow: auto; border: 1px solid rgba(255,255,255,0.1);">
                            <pre style="margin: 0; color: #00ff00; font-family: 'Courier New', monospace; font-size: 0.9rem; line-height: 1.4; white-space: pre-wrap; word-wrap: break-word;">${data.logs}</pre>
                        </div>
                        <div style="background: rgba(255,255,255,0.05); border-radius: 8px; padding: 1rem; margin-top: 1rem; display: flex; gap: 1rem; justify-content: center;">
                            <button onclick="refreshLogs('${appName}')" style="background: #2196F3; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; cursor: pointer; font-weight: 500;">
                                üîÑ Actualizar
                            </button>
                            <button onclick="downloadLogs('${appName}')" style="background: #4CAF50; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; cursor: pointer; font-weight: 500;">
                                üì• Descargar
                            </button>
                            <button onclick="clearLogs('${appName}')" style="background: #f44336; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; cursor: pointer; font-weight: 500;">
                                üóëÔ∏è Limpiar
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Add click outside to close
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.remove();
                }
            });
            
            // Add escape key to close
            const escapeHandler = (e) => {
                if (e.key === 'Escape') {
                    modal.remove();
                    document.removeEventListener('keydown', escapeHandler);
                }
            };
            document.addEventListener('keydown', escapeHandler);
            
        } else {
            showNotification(`‚ùå Error: ${data.error || 'No se pudieron cargar los logs'}`, 'error');
        }
    } catch (error) {
        showNotification(`‚ùå Error de conexi√≥n: ${error.message}`, 'error');
    }
}

async function refreshLogs(appName) {
    try {
        const response = await fetch(`/api/devtools/get_logs?app_name=${encodeURIComponent(appName)}`);
        const data = await parseJSONResponse(response);
        
        if (data.success && data.logs) {
            const preElement = document.querySelector('#logs-viewer-modal pre');
            if (preElement) {
                preElement.textContent = data.logs;
                showNotification(`üìã Logs de ${appName} actualizados`, 'success');
            }
        }
    } catch (error) {
        showNotification(`‚ùå Error actualizando logs: ${error.message}`, 'error');
    }
}

async function downloadLogs(appName) {
    try {
        const response = await fetch(`/api/devtools/download_logs?app_name=${encodeURIComponent(appName)}`);
        
        if (response.ok) {
            const blob = await response.blob();
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${appName}_logs.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
            showNotification(`üì• Logs de ${appName} descargados`, 'success');
        } else {
            showNotification(`‚ùå Error descargando logs`, 'error');
        }
    } catch (error) {
        showNotification(`‚ùå Error descargando logs: ${error.message}`, 'error');
    }
}

async function clearLogs(appName) {
    if (confirm(`‚ö†Ô∏è ¬øEst√°s seguro de que quieres limpiar los logs de ${appName}? Esta acci√≥n no se puede deshacer.`)) {
        try {
            const response = await fetch(`/api/devtools/clear_logs`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ app_name: appName })
            });
            
            const data = await parseJSONResponse(response);
            
            if (data.success) {
                const preElement = document.querySelector('#logs-viewer-modal pre');
                if (preElement) {
                    preElement.textContent = 'Logs limpiados. No hay entradas nuevas.';
                }
                showNotification(`üóëÔ∏è Logs de ${appName} limpiados`, 'success');
            } else {
                showNotification(`‚ùå Error: ${data.error}`, 'error');
            }
        } catch (error) {
            showNotification(`‚ùå Error limpiando logs: ${error.message}`, 'error');
        }
    }
}

// Add animations
const style = document.createElement('style');
style.textContent = `
    @keyframes slideIn {
        from { transform: translateX(100%); opacity: 0; }
        to { transform: translateX(0); opacity: 1; }
    }
    @keyframes slideOut {
        from { transform: translateX(0); opacity: 1; }
        to { transform: translateX(100%); opacity: 0; }
    }
`;
document.head.appendChild(style);
</script>
{% endblock %}
